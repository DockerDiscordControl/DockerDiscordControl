{% extends '_base.html' %}

{% block title %}DDC Configuration{% endblock %}

{% block content %}
    <div class="text-center logo-header">
        <img src="{{ url_for('static', filename='ddc_web.png') }}" alt="DDC Logo">
        <div class="ddc-title">
            <span class="neon-text-large" id="neon-ddc">DDC</span>
        </div>
    </div>
    <h2 class="text-center my-3">DockerDiscordControl</h2>
    <p class="text-center lead" style="color:#adb5bd;">Configure your DDC Bot here.</p>

    {# Donation Section #}
    <div class="text-center my-4 donation-section" id="donationSection">
        <p style="color:#adb5bd; margin-bottom: 10px;">If you find DDC helpful, consider supporting its development:</p>
        <span class="d-inline-block mx-2 align-middle">
            <a href="https://buymeacoffee.com/dockerdiscordcontrol" target="_blank" rel="noopener noreferrer" class="bmc-button donation-button" data-donation-type="coffee" title="Buy Me A Coffee">
                <img src="https://cdn.buymeacoffee.com/buttons/v2/default-yellow.png" alt="Buy Me A Coffee" style="height: 40px !important; width: auto !important;">
            </a>
        </span>
        <span class="d-inline-block mx-2 align-middle">
            <a href="https://www.paypal.com/donate/?hosted_button_id=XKVC6SFXU2GW4" target="_blank" rel="noopener noreferrer" class="btn btn-sm donation-button" data-donation-type="paypal" style="background-color: #0070ba; border-color: #0070ba; color: white; height: 40px; line-height: 28px;" title="Donate with PayPal">
               <i class="bi bi-paypal"></i> Donate with PayPal
            </a>
        </span>
        
        <!-- Donation Test Controls -->
        <div class="w-100 mt-2">
            <div class="text-center">
                <div class="btn-group" role="group" aria-label="Donation controls">
                    <button type="button" class="btn btn-sm btn-success" onclick="addTestFuel(5)" title="Add $5">
                        <i class="bi bi-plus-circle"></i> +$5
                    </button>
                    <button type="button" class="btn btn-sm btn-success" onclick="addTestFuel(10)" title="Add $10">
                        <i class="bi bi-plus-circle"></i> +$10
                    </button>
                    <button type="button" class="btn btn-sm btn-success" onclick="addTestFuel(50)" title="Add $50">
                        <i class="bi bi-plus-circle"></i> +$50
                    </button>
                    <button type="button" class="btn btn-sm btn-warning" onclick="addTestFuel(100)" title="Add $100">
                        <i class="bi bi-plus-circle"></i> +$100
                    </button>
                    <button type="button" class="btn btn-sm btn-warning" onclick="addTestFuel(500)" title="Add $500">
                        <i class="bi bi-rocket"></i> +$500
                    </button>
                    <button type="button" class="btn btn-sm btn-danger" onclick="addTestFuel(-10)" title="Remove $10">
                        <i class="bi bi-dash-circle"></i> -$10
                    </button>
                    <button type="button" class="btn btn-sm btn-secondary" onclick="resetFuel()" title="Reset to 0">
                        <i class="bi bi-arrow-counterclockwise"></i> Reset
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Mech Fuel Call-to-Action -->
        <div class="text-center mb-3">
            <p style="color:#adb5bd; margin-bottom: 10px;">Fuel the Mech with your donations to bring it to life!</p>
        </div>
        
        <!-- Donator Mech Animation - Below buttons -->
        <div class="w-100 mt-3">
            <div class="donator-mech-container d-flex align-items-center" title="Donation Mech Status">
                <!-- Left side: Mech + Speed -->
                <div class="mech-section d-flex flex-column align-items-center">
                    <div id="donatorMech" class="mech-display">
                        <img id="mechAnimation" src="/static/animatedmech.png" alt="Mech" style="height: 120px; width: auto;" onerror="this.style.display='none'; this.parentElement.innerHTML='<div style=&quot;width: 120px; height: 120px; display: flex; align-items: center; justify-content: center; font-size: 48px; color: #666;&quot;>ðŸ¤–</div>'">
                        <div class="mech-loading" style="display: none;">
                            <div class="spinner-border spinner-border-sm text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                        <div id="fuelConsumptionOverlay" class="fuel-consumption-overlay">-$0.00003472</div>
                        <div id="speedStatusOverlay" class="speed-status-overlay">OFFLINE</div>
                    </div>
                </div>
                
                <!-- Right side: Gauge Container -->
                <div class="gauge-container">
                    
                    <!-- Fuel Bar -->
                    <div class="bar-row">
                        <div class="bar-wrapper">
                            <div class="fuel-bar">
                                <div id="fuelLevel" class="fuel-fill" style="width: 0%"></div>
                            </div>
                        </div>
                        <div class="bar-label">
                            <span style="color: #ff4444; font-weight: bold;">FUEL</span>
                            <span id="fuelAmount" style="color: #ffaa00; margin-left: 5px;">$0</span>
                        </div>
                    </div>
                    
                    <!-- Evolution Bar -->
                    <div class="bar-row">
                        <div class="bar-wrapper">
                            <div class="evolution-bar">
                                <div id="evolutionProgress" class="evolution-fill" style="width: 0%"></div>
                            </div>
                        </div>
                        <div class="bar-label">
                            <span id="nextEvolutionInfo" style="color: #888; font-size: 11px; display: flex; flex-direction: column; justify-content: center; height: 100%;">
                                <span id="nextEvolutionName" style="color: #aaa;">REPAIRED MECH</span>
                                <span id="nextEvolutionAmount" style="color: #ffcc00; font-weight: bold;">$20 needed</span>
                            </span>
                        </div>
                    </div>
                    
                </div>
            </div>
        </div>
        
        {# Matrix Terminal Thank You Overlay - Hidden by default #}
        <div id="thankYouOverlay" class="matrix-terminal-overlay" style="display: none;">
            <div class="terminal-content">
                <div class="terminal-text">
                    <span id="thankYouText"></span>
                    <span id="cursor" class="cursor">_</span>
                </div>
            </div>
        </div>

        {# Donation Input Modal - Hidden by default #}
        <div id="donationModal" class="donation-modal-overlay" style="display: none;">
            <div class="donation-modal">
                <div class="donation-modal-header">
                    <h4>ðŸŽ‰ Thank you for your donation!</h4>
                    <p>Please enter your donation details to fuel the mech:</p>
                </div>
                <div class="donation-modal-body">
                    <form id="donationForm">
                        <div class="form-group">
                            <label for="donationAmount">Donation Amount ($)</label>
                            <input type="number" id="donationAmount" class="form-control" min="0.01" step="0.01" placeholder="5.00" required>
                        </div>
                        <div class="form-group">
                            <label for="donorName">Donor Name (optional)</label>
                            <input type="text" id="donorName" class="form-control" placeholder="Anonymous" maxlength="50">
                        </div>
                        <div class="form-group">
                            <div class="form-check">
                                <input type="checkbox" id="publishToDiscord" class="form-check-input" checked>
                                <label for="publishToDiscord" class="form-check-label">
                                    Announce donation in Discord channels
                                </label>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="donation-modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeDonationModal()">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="submitDonation()">ðŸš€ Fuel the Mech!</button>
                </div>
            </div>
        </div>
    </div>

    <style>
        /* Donation Button Animations */
        .donation-button {
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .donation-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
        }
        
        .donation-button:active {
            transform: scale(0.95);
        }

        /* MATRIX TERMINAL OVERLAY */
        .matrix-terminal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: #000000;
            z-index: 2500;
            display: block;
            font-family: 'Courier New', 'Monaco', 'Menlo', monospace;
            animation: terminalFadeIn 0.3s ease-out;
            overflow: hidden;
        }
        
        @keyframes terminalFadeIn {
            0% { opacity: 0; }
            100% { opacity: 1; }
        }
        
        .terminal-content {
            padding: 20px;
            width: 100%;
            height: 100%;
        }
        
        .terminal-text {
            color: #00ff00;
            font-size: 18px;
            font-weight: bold;
            line-height: 1.2;
            text-align: left;
        }
        
        .cursor {
            color: #00ff00;
            font-size: 18px;
            font-weight: bold;
            animation: cursorBlink 1s infinite;
        }
        
        @keyframes cursorBlink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }
        
        /* Matrix Terminal Complete */
        
        /* Donator Mech Status */
        .donator-mech-container {
            padding: 16px;
            background: rgba(0,0,0,0.4);
            border-radius: 12px;
            max-width: 620px;
            margin: 0 auto;
            min-height: 140px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .mech-section {
            min-width: 180px;
            margin-right: 16px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .mech-display {
            height: 120px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            margin-bottom: 4px;
        }
        
        .fuel-consumption-overlay {
            position: absolute;
            top: 2px;
            right: 2px;
            background: transparent;
            color: #ff4444;
            font-size: 11px;
            font-weight: bold;
            z-index: 10;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s ease;
            text-align: center;
        }
        
        .speed-status-overlay {
            position: absolute;
            top: 2px;
            left: 2px;
            background: transparent;
            color: #888888;
            font-size: 10px;
            font-weight: bold;
            z-index: 10;
            pointer-events: none;
            text-align: left;
            max-width: 120px;
            word-wrap: break-word;
            line-height: 1.1;
        }
        
        /* Donation Modal Styles */
        .donation-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            animation: modalFadeIn 0.3s ease;
        }
        
        .donation-modal {
            background: #1a1a1a;
            border: 2px solid #444;
            border-radius: 12px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            animation: modalSlideIn 0.4s ease;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.7);
        }
        
        .donation-modal-header {
            padding: 20px 20px 10px;
            border-bottom: 1px solid #333;
            text-align: center;
        }
        
        .donation-modal-header h4 {
            color: #ffcc00;
            margin: 0 0 10px 0;
            font-size: 1.4em;
        }
        
        .donation-modal-header p {
            color: #adb5bd;
            margin: 0;
            font-size: 0.95em;
        }
        
        .donation-modal-body {
            padding: 20px;
        }
        
        .donation-modal-footer {
            padding: 10px 20px 20px;
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }
        
        .donation-modal .form-group {
            margin-bottom: 18px;
        }
        
        .donation-modal label {
            display: block;
            color: #fff;
            font-weight: 500;
            margin-bottom: 5px;
            font-size: 0.9em;
        }
        
        .donation-modal .form-control {
            background: #2a2a2a;
            border: 1px solid #444;
            border-radius: 6px;
            color: #fff;
            padding: 10px 12px;
            font-size: 0.95em;
            width: 100%;
            transition: border-color 0.2s;
        }
        
        .donation-modal .form-control:focus {
            outline: none;
            border-color: #ffcc00;
            box-shadow: 0 0 0 2px rgba(255, 204, 0, 0.2);
        }
        
        .donation-modal .form-check {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .donation-modal .form-check-input {
            width: 18px;
            height: 18px;
            margin: 0;
        }
        
        .donation-modal .form-check-label {
            color: #adb5bd;
            margin: 0;
            font-size: 0.9em;
            cursor: pointer;
        }
        
        @keyframes modalFadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes modalSlideIn {
            from { transform: scale(0.9) translateY(-20px); opacity: 0; }
            to { transform: scale(1) translateY(0); opacity: 1; }
        }
        
        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        @keyframes slideOutRight {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }
        
        .gauge-container {
            display: flex;
            flex-direction: column;
            justify-content: center;
            min-width: 320px;
            flex: 1;
            gap: 16px;
            height: 120px;
        }
        
        .bar-row {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .bar-wrapper {
            flex: 0 0 150px;
            margin-right: 0;
        }
        
        .bar-label {
            flex: 0 0 auto;
            font-size: 11px;
            white-space: nowrap;
            margin-left: 0;
        }
        
        .fuel-bar, .evolution-bar {
            width: 150px;
            height: 28px;
            background: #1a1a1a;
            border: 2px solid #444;
            border-radius: 8px;
            overflow: hidden;
            position: relative;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.5);
        }
        
        .fuel-fill {
            height: 100%;
            background: linear-gradient(90deg, #cc0000 0%, #ff3333 50%, #ff6666 100%);
            transition: width 0.5s ease;
            box-shadow: 0 0 10px rgba(255, 0, 0, 0.3);
        }
        
        .evolution-fill {
            height: 100%;
            background: linear-gradient(90deg, #00ffff 0%, #00ccff 50%, #00ffff 100%);
            transition: width 0.5s ease;
            box-shadow: 0 0 10px rgba(0, 255, 255, 0.5);
        }
        
        .evolution-name {
            font-size: 11px;
            font-weight: bold;
            color: #cc00ff;
            text-align: center;
            text-shadow: 0 0 3px rgba(204, 0, 255, 0.5);
        }
        
        .next-evolution-info {
            margin-top: 5px;
            padding-top: 5px;
            border-top: 1px dotted #444;
        }
        
        .fuel-amount {
            font-size: 14px;
            font-weight: bold;
            color: #ffcc00;
            margin-top: 4px;
            text-align: center;
            text-shadow: 0 0 5px rgba(255, 204, 0, 0.5);
        }
        
        /* Gray state (inactive/old donation) - NO PULSE */
        .donator-heart.inactive {
            color: #6c757d;
            text-shadow: none;
            animation: none; /* No pulsing when inactive */
        }
        
        /* Neon active state (recent donation) - animation set by JavaScript */
        .donator-heart.active {
            color: #36cfff;
            text-shadow: 0 0 10px #36cfff, 0 0 20px #36cfff, 0 0 40px #36cfff;
            /* Animation set dynamically by JavaScript */
        }
        
        /* Fading state - NO PULSE, color set by JavaScript */
        .donator-heart.fading {
            animation: none; /* No pulsing during fade */
            /* Color and text-shadow set dynamically by JavaScript */
        }
        
        /* Dynamic heart pulse animations - generated by JavaScript */
        @keyframes heartPulseFast {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.15); }
        }
        
        @keyframes heartPulseMedium {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        
        @keyframes heartPulseSlow {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.08); }
        }
        
        @keyframes heartPulseVerySlow {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .terminal-text, .cursor { 
                font-size: 14px; 
            }
            .terminal-content {
                padding: 15px;
            }
        }
    </style>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const donationButtons = document.querySelectorAll('.donation-button');
            const thankYouOverlay = document.getElementById('thankYouOverlay');
            const donatorHeart = document.getElementById('donatorHeart');
            
            donationButtons.forEach(button => {
                button.addEventListener('click', function(e) {
                    const donationType = this.getAttribute('data-donation-type');
                    
                    // Record donation click to server
                    fetch('/api/donation/click', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            type: donationType
                        })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            // Store for thank you display
                            localStorage.setItem('ddcDonationClick', JSON.stringify({
                                type: donationType,
                                timestamp: data.timestamp
                            }));
                            
                            // Update mech immediately
                            checkDonatorMechStatus();
                        }
                    })
                    .catch(error => {
                        console.error('Error recording donation:', error);
                    });
                    
                    // Allow normal link behavior (open in new tab)
                    // No e.preventDefault() - let the browser handle the link normally
                });
            });
            
            // Check for donation return on page focus/load
            let isProcessingDonationReturn = false;
            function checkForDonationReturn() {
                console.log('checkForDonationReturn called');
                if (isProcessingDonationReturn) {
                    console.log('Already processing, returning');
                    return; // Prevent multiple simultaneous calls
                }
                
                const donationData = localStorage.getItem('ddcDonationClick');
                console.log('localStorage data:', donationData);
                if (donationData) {
                    try {
                        isProcessingDonationReturn = true;
                        const data = JSON.parse(donationData);
                        const timeSinceClick = Date.now() - data.timestamp;
                        
                        console.log('Time since click:', timeSinceClick);
                        // Show thank you if donation was clicked within last 10 minutes
                        if (timeSinceClick < 10 * 60 * 1000) {
                            // Mark as shown with timestamp to prevent multiple shows of SAME click
                            const shownKey = `ddcDonationShown_${data.timestamp}`;
                            console.log('Checking if already shown:', shownKey);
                            
                            if (!localStorage.getItem(shownKey)) {
                                console.log('Showing thank you overlay');
                                // Mark this specific donation click as shown
                                localStorage.setItem(shownKey, 'true');
                                
                                // Clean up old shown markers (older than 1 hour)
                                cleanupOldDonationMarkers();
                                
                                // Show the thank you overlay
                                showThankYouOverlay(data.type);
                                
                                // Also show the donation modal immediately (behind the Matrix overlay)
                                console.log('Also showing donation modal behind Matrix overlay');
                                if (typeof window.showDonationModal === 'function') {
                                    window.showDonationModal();
                                } else {
                                    // Fallback if function not yet available
                                    const modal = document.getElementById('donationModal');
                                    if (modal) {
                                        modal.style.display = 'flex';
                                    }
                                }
                            } else {
                                console.log('Already shown this donation');
                            }
                        } else {
                            console.log('Donation too old');
                        }
                        
                        // Clear the click data after showing (but preserve for future multiple checks)
                        localStorage.removeItem('ddcDonationClick');
                    } catch (e) {
                        // Clean up invalid data
                        localStorage.removeItem('ddcDonationClick');
                    } finally {
                        isProcessingDonationReturn = false;
                    }
                } else {
                    isProcessingDonationReturn = false;
                }
            }
            
            function cleanupOldDonationMarkers() {
                const oneHourAgo = Date.now() - (60 * 60 * 1000);
                const keysToRemove = [];
                let totalCleaned = 0;
                
                // Find old donation markers and other DDC data
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key) {
                        // Clean old donation markers
                        if (key.startsWith('ddcDonationShown_')) {
                            const timestamp = parseInt(key.replace('ddcDonationShown_', ''));
                            if (isNaN(timestamp) || timestamp < oneHourAgo) {
                                keysToRemove.push(key);
                                totalCleaned++;
                            }
                        }
                        // Also clean any malformed DDC keys
                        else if (key.startsWith('ddc') && key.includes('undefined')) {
                            keysToRemove.push(key);
                            totalCleaned++;
                        }
                    }
                }
                
                // Remove old markers
                keysToRemove.forEach(key => localStorage.removeItem(key));
                
                if (totalCleaned > 0) {
                    console.log(`Cleaned ${totalCleaned} old localStorage entries`);
                }
            }
            
            function showThankYouOverlay(donationType) {
                console.log('showThankYouOverlay called with type:', donationType);
                showMatrixTerminal();
            }
            
            // Make function globally available for testing
            window.checkForDonationReturn = checkForDonationReturn;
            
            // Check on page load
            checkForDonationReturn();
            
            // Check when window gets focus (user returns from donation page)
            window.addEventListener('focus', function() {
                // Small delay to ensure page is fully focused
                setTimeout(checkForDonationReturn, 500);
            });
            
            // Check on visibility change (better detection for modern browsers)
            document.addEventListener('visibilitychange', function() {
                if (!document.hidden) {
                    setTimeout(checkForDonationReturn, 500);
                }
            });
            
            // Auto-close after 8 seconds OR click overlay to close immediately
            let autoCloseTimer = null;
            
            function closeThankYou() {
                if (autoCloseTimer) {
                    clearTimeout(autoCloseTimer);
                    autoCloseTimer = null;
                }
                thankYouOverlay.style.animation = 'thankYouFadeOut 0.5s ease-out';
                setTimeout(() => {
                    thankYouOverlay.style.display = 'none';
                    thankYouOverlay.style.animation = '';
                    console.log('Matrix Thank You closed, donation modal should already be visible');
                    // Modal should already be open, just focus on input
                    const amountInput = document.getElementById('donationAmount');
                    if (amountInput) {
                        amountInput.focus();
                        console.log('Amount input focused');
                    }
                }, 500);
            }
            
            // Click overlay to close immediately
            thankYouOverlay.addEventListener('click', closeThankYou);
            
            // Auto-close after 8 seconds if no interaction
            thankYouOverlay.addEventListener('animationend', function(e) {
                if (e.animationName === 'thankYouFadeIn') {
                    autoCloseTimer = setTimeout(closeThankYou, 8000);
                }
            });
        });
        
        // Matrix Terminal Animation
        
        function showMatrixTerminal() {
            console.log('showMatrixTerminal called');
            const overlay = document.getElementById('thankYouOverlay');
            const textElement = document.getElementById('thankYouText');
            
            console.log('Matrix overlay:', overlay);
            console.log('Matrix text element:', textElement);
            
            if (!overlay || !textElement) {
                console.error('Matrix elements not found!');
                return;
            }
            
            // Show overlay
            overlay.style.display = 'flex';
            textElement.innerHTML = '';
            
            // Timeline: 10 seconds total
            // 0-2s: Cursor blinks
            // 2-4s: Type "Thank You!"
            // 4-6s: Cursor blinks alone 
            // 6-8s: Type "You rule!"
            // 8-10s: Cursor blinks alone
            // 10s: Close
            
            setTimeout(() => {
                typeText(textElement, 'Thank You!', 100, () => {
                    setTimeout(() => {
                        textElement.innerHTML += ' ';
                        typeText(textElement, 'You rule!', 100, () => {
                            setTimeout(() => {
                                overlay.style.display = 'none';
                                textElement.innerHTML = '';
                            }, 2000); // Wait 2s then close
                        });
                    }, 2000); // Wait 2s between messages
                });
            }, 2000); // Wait 2s before first message
        }
        
        function typeText(element, text, speed, callback) {
            let i = 0;
            const timer = setInterval(() => {
                if (i < text.length) {
                    element.innerHTML += text.charAt(i);
                    i++;
                } else {
                    clearInterval(timer);
                    if (callback) callback();
                }
            }, speed);
        }
        
        // Donator Heart Management
        function updateDonatorHeart(donationTimestamp) {
            // No longer storing locally - server handles it
            // Just refresh the mech status from server
            checkDonatorMechStatus();
        }
        
        // Speed description function (simplified version of Python speed_levels.py)
        function getSpeedDescription(level) {
            const speeds = {
                0: {text: "OFFLINE", color: "#888888"},
                1: {text: "Motionless ðŸŒ", color: "#4a4a4a"},
                2: {text: "Barely perceptible ðŸŒ", color: "#525252"},
                3: {text: "Extremely sluggish ðŸŒ", color: "#5a5a5a"},
                4: {text: "Painfully hesitant ðŸŒ", color: "#626262"},
                5: {text: "Excruciatingly lethargic ðŸŒ", color: "#6a6a6a"},
                10: {text: "Glacially slow ðŸŒ", color: "#929292"},
                15: {text: "Faltering pace ðŸŒ", color: "#bababa"},
                20: {text: "Slow but continuous ðŸŒ", color: "#e2e2e2"},
                25: {text: "Measured walking ðŸš¶", color: "#ccaa00"},
                30: {text: "Decisive stride ðŸš¶", color: "#88cc00"},
                35: {text: "Fast stride ðŸš¶", color: "#33cc00"},
                40: {text: "Quick-paced ðŸš¶", color: "#00cc22"},
                45: {text: "Hurrying intensely ðŸƒ", color: "#00cc77"},
                50: {text: "Sharply swift ðŸƒ", color: "#00cccc"},
                55: {text: "Racing step ðŸƒ", color: "#0077cc"},
                60: {text: "Almost running ðŸƒ", color: "#0022cc"},
                65: {text: "Fast jogging ðŸƒâ€â™‚ï¸ðŸ’¨", color: "#3300cc"},
                70: {text: "Rapid running ðŸƒâ€â™‚ï¸ðŸ’¨", color: "#8800cc"},
                75: {text: "Relentless sprint ðŸƒâ€â™‚ï¸ðŸ’¨", color: "#cc00bb"},
                80: {text: "Supersonic pace ðŸƒâ€â™‚ï¸ðŸ’¨", color: "#cc0066"},
                85: {text: "Breakneck velocity ðŸš€", color: "#cc0011"},
                90: {text: "Star-chasing speed ðŸš€", color: "#ff3300"},
                95: {text: "Warp-level 5 âš¡", color: "#ff8800"},
                100: {text: "Beyond-lightspeed âš¡", color: "#ffdd00"},
                101: {text: "Godspeed ðŸš€âœ¨", color: "#ffff00"}
            };
            
            // Find the closest level match
            let bestMatch = speeds[0];
            for (let speedLevel in speeds) {
                if (level >= parseInt(speedLevel)) {
                    bestMatch = speeds[speedLevel];
                }
            }
            
            return bestMatch;
        }
        
        function checkDonatorMechStatus() {
            const mechImg = document.getElementById('mechAnimation');
            const mechLoading = document.querySelector('.mech-loading');
            const fuelLevel = document.getElementById('fuelLevel');
            const fuelAmountElement = document.getElementById('fuelAmount');
            
            if (!mechImg || !fuelLevel || !fuelAmountElement) return;
            
            // Fetch donation status from server
            fetch('/api/donation/status')
                .then(response => response.json())
                .then(data => {
                    // Get fuel amount (for speed) and total donations received (for evolution)
                    const fuelAmount = data.total_amount || 0;  // Current fuel
                    const totalDonationsReceived = data.total_donations_received || 0;  // Total ever donated
                    
                    // Update speed status based on FUEL
                    const speedStatus = document.getElementById('speedStatusOverlay');
                    let speedText = '';
                    let speedColor = '#888';
                    
                    // Speed descriptions with colors from speed_system.py
                    const speedDescriptions = {
                        0: ["OFFLINE", "#888888"],
                        1: ["Motionless", "#4a4a4a"], 2: ["Barely perceptible", "#525252"], 3: ["Extremely sluggish", "#5a5a5a"], 4: ["Painfully hesitant", "#626262"], 5: ["Excruciatingly lethargic", "#6a6a6a"],
                        6: ["Ultra-slow", "#727272"], 7: ["Almost crawling", "#7a7a7a"], 8: ["Truly crawling", "#828282"], 9: ["Snail-paced", "#8a8a8a"], 10: ["Glacially slow", "#929292"],
                        11: ["Heavy-footed", "#9a9a9a"], 12: ["Weary plodding", "#a2a2a2"], 13: ["Drearily trudging", "#aaaaaa"], 14: ["Stumbling forward", "#b2b2b2"], 15: ["Faltering pace", "#bababa"],
                        16: ["Limping along", "#c2c2c2"], 17: ["Dragging feet", "#cacaca"], 18: ["Reluctant stride", "#d2d2d2"], 19: ["Sluggish shuffling", "#dadada"], 20: ["Slow but continuous", "#e2e2e2"],
                        21: ["Leisurely relaxed", "#cc6600"], 22: ["Casual and easy", "#cc7700"], 23: ["Moderately steady", "#cc8800"], 24: ["Comfortable stride", "#cc9900"], 25: ["Measured walking", "#ccaa00"],
                        26: ["Balanced and even", "#ccbb00"], 27: ["Mildly brisk", "#bbcc00"], 28: ["Purposeful steady", "#aacc00"], 29: ["Clearly brisker", "#99cc00"], 30: ["Decisive stride", "#88cc00"],
                        31: ["Quickened step", "#77cc00"], 32: ["Energetic pace", "#66cc00"], 33: ["Noticeably brisk", "#55cc00"], 34: ["Sharply focused", "#44cc00"], 35: ["Fast stride", "#33cc00"],
                        36: ["Strong and firm", "#22cc00"], 37: ["Forcefully brisk", "#11cc00"], 38: ["Rapid walking", "#00cc00"], 39: ["Swift step", "#00cc11"], 40: ["Quick-paced", "#00cc22"],
                        41: ["Very brisk", "#00cc33"], 42: ["Clearly fast", "#00cc44"], 43: ["Forcefully rapid", "#00cc55"], 44: ["Rushing forward", "#00cc66"], 45: ["Hurrying intensely", "#00cc77"],
                        46: ["Lively fast", "#00cc88"], 47: ["Speedy motion", "#00cc99"], 48: ["Snappy fast", "#00ccaa"], 49: ["Nimble quick", "#00ccbb"], 50: ["Sharply swift", "#00cccc"],
                        60: ["Almost running", "#0022cc"], 70: ["Rapid running", "#8800cc"], 80: ["Supersonic pace", "#cc0066"], 90: ["Star-chasing speed", "#ff3300"], 
                        95: ["Warp-level 5", "#ff8800"], 99: ["True lightspeed", "#ffcc00"], 100: ["Beyond-lightspeed", "#ffdd00"], 101: ["REALITY-BENDING OMNISPEED", "#ff00ff"]
                    };
                    
                    // Calculate speed level based on fuel amount
                    let speedLevel = 0;
                    if (fuelAmount <= 0) {
                        speedLevel = 0;
                    } else if (fuelAmount <= 100) {
                        // Levels 1-4: Direct 1:1 mapping
                        speedLevel = Math.min(Math.floor(fuelAmount), 100);
                    } else {
                        // Higher levels: complex calculation based on evolution
                        speedLevel = Math.min(Math.floor(fuelAmount / 10), 100);
                        if (fuelAmount >= 20000) speedLevel = 101; // TRANSCENDENT
                    }
                    
                    // Update evolution status based on TOTAL DONATIONS
                    const evolutionThresholds = [0, 20, 50, 100, 200, 400, 800, 1500, 2500, 4000];
                    const evolutionNames = [
                        "SCRAP MECH", "REPAIRED MECH", "STANDARD MECH", "ENHANCED MECH",
                        "ADVANCED MECH", "ELITE MECH", "CYBER MECH", "PLASMA MECH",
                        "QUANTUM MECH", "DIVINE MECH"
                    ];
                    
                    let evolutionLevel = 0;
                    for (let i = evolutionThresholds.length - 1; i >= 0; i--) {
                        if (totalDonationsReceived >= evolutionThresholds[i]) {
                            evolutionLevel = i;
                            break;
                        }
                    }
                    
                    // Update evolution display
                    const evolutionProgressEl = document.getElementById('evolutionProgress');
                    const nextEvolutionNameEl = document.getElementById('nextEvolutionName');
                    const nextEvolutionAmountEl = document.getElementById('nextEvolutionAmount');
                    const nextEvolutionInfoEl = document.getElementById('nextEvolutionInfo');
                    
                    if (evolutionProgressEl) {
                        if (evolutionLevel < 9) {
                            const currentThreshold = evolutionThresholds[evolutionLevel];
                            const nextThreshold = evolutionThresholds[evolutionLevel + 1];
                            const progress = ((totalDonationsReceived - currentThreshold) / (nextThreshold - currentThreshold)) * 100;
                            
                            evolutionProgressEl.style.width = `${Math.min(100, Math.max(0, progress))}%`;
                            nextEvolutionNameEl.textContent = evolutionNames[evolutionLevel + 1];
                            const amountNeeded = nextThreshold - totalDonationsReceived;
                            nextEvolutionAmountEl.textContent = `$${amountNeeded.toFixed(0)} needed`;
                            nextEvolutionInfoEl.style.display = 'inline';
                        } else {
                            // Max level reached
                            evolutionProgressEl.style.width = '100%';
                            nextEvolutionInfoEl.textContent = 'MAX LEVEL REACHED';
                            nextEvolutionInfoEl.style.color = '#ffcc00';
                        }
                    }
                    
                    // Get speed description and color based on calculated level
                    const speedInfo = speedDescriptions[speedLevel] || speedDescriptions[0];
                    speedText = speedInfo[0];
                    speedColor = speedInfo[1];
                    
                    if (speedStatus) {
                        speedStatus.textContent = speedText;
                        speedStatus.style.color = speedColor;
                    }
                    
                    // Update fuel gauge - based on evolution level gap + $10 buffer
                    // Level 0: $20 needed for Level 1 + $10 buffer = $30 max
                    // Level 1: $30 needed for Level 2 ($50-$20) + $10 buffer = $40 max  
                    // Level 2: $50 needed for Level 3 ($100-$50) + $10 buffer = $60 max
                    let maxFuelForBar = 30; // Default for level 0 ($20 + $10)
                    
                    if (evolutionLevel < 9) {
                        // Gap between current and next evolution level + $10 buffer
                        const currentThreshold = evolutionThresholds[evolutionLevel];
                        const nextThreshold = evolutionThresholds[evolutionLevel + 1];
                        const evolutionGap = nextThreshold - currentThreshold;
                        maxFuelForBar = evolutionGap + 10;
                    }
                    
                    // Fuel bar represents current fuel with same scale as evolution bar
                    const fuelPercent = Math.min((fuelAmount / maxFuelForBar) * 100, 100);
                    fuelLevel.style.width = fuelPercent + '%';
                    fuelAmountElement.textContent = '$' + fuelAmount.toFixed(2);
                    
                    // Update fuel bar color based on fuel amount
                    if (fuelAmount >= 1000) {
                        fuelLevel.style.background = 'linear-gradient(90deg, #ffd700 0%, #ffff00 50%, #ffd700 100%)'; // Gold
                    } else if (fuelAmount >= 500) {
                        fuelLevel.style.background = 'linear-gradient(90deg, #00ffff 0%, #00ccff 50%, #00ffff 100%)'; // Cyan
                    } else if (fuelAmount >= 250) {
                        fuelLevel.style.background = 'linear-gradient(90deg, #00ff00 0%, #00dd00 50%, #00ff00 100%)'; // Green
                    } else if (fuelAmount >= 100) {
                        fuelLevel.style.background = 'linear-gradient(90deg, #ffcc00 0%, #ff9900 50%, #ffcc00 100%)'; // Orange
                    } else if (fuelAmount >= 50) {
                        fuelLevel.style.background = 'linear-gradient(90deg, #ff6600 0%, #ff3300 50%, #ff6600 100%)'; // Red-Orange
                    } else {
                        fuelLevel.style.background = 'linear-gradient(90deg, #cc0000 0%, #990000 50%, #cc0000 100%)'; // Red
                    }
                    
                    // Generate mech animation
                    if (mechLoading) mechLoading.style.display = 'block';
                    mechImg.style.display = 'none';
                    
                    fetch('/mech_animation')
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                        }
                        return response.blob();
                    })
                    .then(blob => {
                        const url = URL.createObjectURL(blob);
                        mechImg.src = url;
                        mechImg.style.display = 'block';
                        if (mechLoading) mechLoading.style.display = 'none';
                        
                        // Set title based on speed level
                        let speedText = 'Walking';
                        if (fuelAmount >= 1000) speedText = 'LIGHTSPEED!';
                        else if (fuelAmount >= 500) speedText = 'Hyperspeed';
                        else if (fuelAmount >= 250) speedText = 'Sprinting';
                        else if (fuelAmount >= 100) speedText = 'Running';
                        else if (fuelAmount >= 50) speedText = 'Jogging';
                        
                        mechImg.parentElement.parentElement.title = `Mech Status: ${speedText} | Fuel: ${fuelAmount.toFixed(2)}â‚¬`;
                    })
                    .catch(error => {
                        console.error('Error generating mech animation:', error);
                        if (mechLoading) mechLoading.style.display = 'none';
                    });
                    
                    return;  // Skip old heart animation code
                    
                    const daysSinceDonation = data.days_since_donation;
                    
                    if (daysSinceDonation <= 30) {
                // Calculate exact day (0-30)
                const dayNumber = Math.floor(daysSinceDonation);
                const fadePercentage = daysSinceDonation / 30;
                
                // Calculate color transition from #36cfff (neon blue) to #6c757d (gray)
                const startR = 0x36, startG = 0xcf, startB = 0xff; // #36cfff
                const endR = 0x6c, endG = 0x75, endB = 0x7d;       // #6c757d
                
                const currentR = Math.round(startR + (endR - startR) * fadePercentage);
                const currentG = Math.round(startG + (endG - startG) * fadePercentage);
                const currentB = Math.round(startB + (endB - startB) * fadePercentage);
                
                const currentColor = `rgb(${currentR}, ${currentG}, ${currentB})`;
                
                // Reset styles
                heart.style.color = '';
                heart.style.filter = '';
                heart.style.textShadow = '';
                heart.style.animation = '';
                
                if (dayNumber <= 7) {
                    // Days 0-7: Fast pulse + full glow
                    heart.className = 'bi bi-heart-fill donator-heart active';
                    const pulseSpeed = 1 + (dayNumber * 0.2); // 1s to 2.4s
                    heart.style.animation = `heartPulseFast ${pulseSpeed}s ease-in-out infinite`;
                    heart.title = `Fresh donation! Thank you! â¤ï¸ (Day ${dayNumber})`;
                } else if (dayNumber <= 15) {
                    // Days 8-15: Medium pulse + medium glow
                    heart.className = 'bi bi-heart-fill donator-heart fading';
                    heart.style.color = currentColor;
                    
                    // Reduced glow
                    const glowStrength = 1 - ((dayNumber - 7) / 8) * 0.7; // 100% to 30%
                    const glowColor = `rgba(54, 207, 255, ${glowStrength})`;
                    heart.style.textShadow = `0 0 ${10 * glowStrength}px ${glowColor}, 0 0 ${20 * glowStrength}px ${glowColor}`;
                    
                    const pulseSpeed = 2.4 + ((dayNumber - 7) * 0.3); // 2.4s to 4.8s
                    heart.style.animation = `heartPulseMedium ${pulseSpeed}s ease-in-out infinite`;
                    
                    const daysLeft = Math.ceil(30 - daysSinceDonation);
                    heart.title = `Donator status expires in ${daysLeft} days. Thank you! â¤ï¸ (Day ${dayNumber})`;
                } else if (dayNumber <= 28) {
                    // Days 16-28: Slow pulse + no glow
                    heart.className = 'bi bi-heart-fill donator-heart fading';
                    heart.style.color = currentColor;
                    heart.style.textShadow = 'none';
                    
                    const pulseSpeed = 4.8 + ((dayNumber - 15) * 0.4); // 4.8s to 10s
                    heart.style.animation = `heartPulseSlow ${pulseSpeed}s ease-in-out infinite`;
                    
                    const daysLeft = Math.ceil(30 - daysSinceDonation);
                    heart.title = `Donator status expires in ${daysLeft} days. Thank you! â¤ï¸ (Day ${dayNumber})`;
                } else {
                    // Days 29-30: Very slow pulse + almost gray
                    heart.className = 'bi bi-heart-fill donator-heart fading';
                    heart.style.color = currentColor;
                    heart.style.textShadow = 'none';
                    
                    const pulseSpeed = 10 + ((dayNumber - 28) * 5); // 10s to 20s
                    heart.style.animation = `heartPulseVerySlow ${pulseSpeed}s ease-in-out infinite`;
                    
                    const daysLeft = Math.ceil(30 - daysSinceDonation);
                    heart.title = `Donator status expires in ${daysLeft} days. Thank you! â¤ï¸ (Day ${dayNumber})`;
                }
                    } else {
                        // Expired - gray heart
                        heart.className = 'bi bi-heart-fill donator-heart inactive';
                        heart.style.color = ''; // Reset inline style
                        heart.style.filter = ''; // Reset inline style
                        heart.style.textShadow = ''; // Reset inline style
                        heart.style.animation = '';
                        heart.title = 'Support DDC development â¤ï¸';
                    }
                })
                .catch(error => {
                    console.error('Error fetching donation status:', error);
                    // On error, show inactive heart
                    heart.className = 'bi bi-heart-fill donator-heart inactive';
                    heart.style.color = '';
                    heart.style.filter = '';
                    heart.style.textShadow = '';
                    heart.style.animation = '';
                });
        }
        
        // Check mech status on page load
        checkDonatorMechStatus();
        
        // Update mech status every 5 minutes (server-side tracking now)
        setInterval(checkDonatorMechStatus, 5 * 60 * 1000);
        
        // Consume fuel every 3 seconds (backend only, no Next Bar animation)
        function consumeFuel() {
            const fuelAmount = document.getElementById('fuelAmount');
            
            if (fuelAmount) {
                // Parse current fuel amount
                const currentFuel = parseFloat(fuelAmount.textContent.replace('$', ''));
                
                // Only consume fuel if we have fuel
                if (currentFuel > 0) {
                    // Actually consume fuel on server
                    fetch('/api/donation/consume-fuel', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            amount: 0.00003472  // Exact amount for 1$ per day
                        })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            // Update display with new amount
                            fuelAmount.textContent = '$' + data.new_fuel.toFixed(5);
                            
                            // If fuel hits 0, refresh mech animation
                            if (data.new_fuel <= 0) {
                                setTimeout(() => {
                                    checkDonatorMechStatus();
                                }, 1500);
                            }
                        }
                    })
                    .catch(error => {
                        console.error('Error consuming fuel:', error);
                    });
                }
            }
        }
        
        // Start fuel consumption every 3 seconds
        setInterval(consumeFuel, 3000);
        
        // Flash consumption overlay with fade animation every 3 seconds (only if fuel > 0)
        function flashConsumptionOverlay() {
            const overlay = document.getElementById('fuelConsumptionOverlay');
            const fuelAmount = document.getElementById('fuelAmount');
            
            if (overlay && fuelAmount) {
                // Parse current fuel amount
                const currentFuel = parseFloat(fuelAmount.textContent.replace('$', ''));
                
                // Only show consumption animation if we have fuel
                if (currentFuel > 0) {
                    overlay.style.transition = 'opacity 0.3s ease-in';
                    overlay.style.opacity = '1';
                    
                    // Hide after 1 second (same timing as Next Bar)
                    setTimeout(() => {
                        overlay.style.transition = 'opacity 0.5s ease-out';
                        overlay.style.opacity = '0';
                    }, 1000);
                }
            }
        }
        
        // Start consumption overlay flash every 3 seconds
        setInterval(flashConsumptionOverlay, 3000);
        
        // Donation Modal Functions
        function showDonationModal() {
            const modal = document.getElementById('donationModal');
            if (modal) {
                // Prevent double-opening
                if (modal.style.display === 'flex') {
                    return;
                }
                
                modal.style.display = 'flex';
                // Focus on amount input
                setTimeout(() => {
                    const amountInput = document.getElementById('donationAmount');
                    if (amountInput) {
                        amountInput.focus();
                    }
                }, 100);
            }
        }
        
        // Make modal functions globally available
        window.showDonationModal = showDonationModal;
        
        function closeDonationModal() {
            const modal = document.getElementById('donationModal');
            if (modal) {
                modal.style.display = 'none';
                // Reset form
                document.getElementById('donationForm').reset();
                document.getElementById('publishToDiscord').checked = true; // Default to checked
            }
        }
        
        function submitDonation() {
            const amountInput = document.getElementById('donationAmount');
            const donorNameInput = document.getElementById('donorName');
            const publishCheckbox = document.getElementById('publishToDiscord');
            
            // Check if elements exist
            if (!amountInput || !donorNameInput || !publishCheckbox) {
                alert('Error: Form elements not found. Please try again.');
                return;
            }
            
            const amount = amountInput.value.trim();
            const donorName = donorNameInput.value.trim() || 'Anonymous';
            const publishToDiscord = publishCheckbox.checked;
            
            // Enhanced amount validation
            if (!amount) {
                alert('Please enter a donation amount.');
                amountInput.focus();
                return;
            }
            
            const parsedAmount = parseFloat(amount);
            if (isNaN(parsedAmount) || parsedAmount <= 0) {
                alert('Please enter a valid positive donation amount.');
                amountInput.focus();
                return;
            }
            
            if (parsedAmount > 999999) {
                alert('Maximum donation amount is $999,999.');
                amountInput.focus();
                return;
            }
            
            // Validate donor name length
            if (donorName.length > 50) {
                alert('Donor name must be 50 characters or less.');
                donorNameInput.focus();
                return;
            }
            
            // Disable submit button to prevent double-submission
            const submitBtn = document.querySelector('button[onclick="submitDonation()"]');
            if (submitBtn) {
                submitBtn.disabled = true;
                submitBtn.textContent = 'â³ Processing...';
            }
            
            // Helper function to re-enable button
            function resetSubmitButton() {
                if (submitBtn) {
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'ðŸš€ Fuel the Mech!';
                }
            }
            
            // Prepare donation data
            const donationData = {
                amount: parseFloat(amount),
                donor_name: donorName,
                publish_to_discord: publishToDiscord,
                source: 'web_ui_manual'
            };
            
            // Submit donation to server with timeout
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 30000); // 30 second timeout
            
            fetch('/api/donation/submit', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(donationData),
                signal: controller.signal
            })
            .then(response => {
                clearTimeout(timeoutId);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    // Reset button first
                    resetSubmitButton();
                    
                    // Close modal
                    closeDonationModal();
                    
                    // Refresh mech status to show new fuel
                    checkDonatorMechStatus();
                    
                    // Show success message
                    showSuccessMessage(`ðŸš€ Thank you ${donorName}! $${amount} added to mech fuel!`);
                } else {
                    alert('Error processing donation: ' + (data.error || 'Unknown error'));
                    resetSubmitButton();
                }
            })
            .catch(error => {
                clearTimeout(timeoutId);
                console.error('Error submitting donation:', error);
                
                // Better error messages for users
                let userMessage = 'Error submitting donation. Please try again.';
                if (error.name === 'AbortError') {
                    userMessage = 'Request timeout. Please check your connection and try again.';
                } else if (error.message.includes('HTTP')) {
                    userMessage = `Server error: ${error.message}. Please try again later.`;
                } else if (!navigator.onLine) {
                    userMessage = 'No internet connection. Please check your connection.';
                }
                
                alert(userMessage);
                resetSubmitButton();
            });
        }
        
        function showSuccessMessage(message) {
            // Create temporary success message
            const successDiv = document.createElement('div');
            successDiv.innerHTML = `
                <div class="alert alert-success" style="position: fixed; top: 20px; right: 20px; z-index: 3000; animation: slideInRight 0.3s ease;">
                    ${message}
                </div>
            `;
            document.body.appendChild(successDiv);
            
            // Remove after 4 seconds
            setTimeout(() => {
                successDiv.style.animation = 'slideOutRight 0.3s ease';
                setTimeout(() => document.body.removeChild(successDiv), 300);
            }, 4000);
        }
        
        // Close modal when clicking overlay background
        document.addEventListener('click', function(event) {
            const modal = document.getElementById('donationModal');
            if (event.target === modal) {
                closeDonationModal();
            }
        });
        
        // Close modal with Escape key
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                closeDonationModal();
            }
        });
        
        // Test Functions for Matrix Thank You (Global scope)
        window.testMatrixThankYou = function() {
            console.log('testMatrixThankYou called');
            
            // Simulate donation button click for testing
            const donationData = {
                type: 'coffee',
                timestamp: Date.now()
            };
            localStorage.setItem('ddcDonationClick', JSON.stringify(donationData));
            console.log('localStorage set:', donationData);
            
            // Check for donation return
            if (window.checkForDonationReturn) {
                console.log('Calling checkForDonationReturn...');
                window.checkForDonationReturn();
            } else {
                console.error('checkForDonationReturn not yet available');
            }
        }
        
        // Test Functions for Adding/Removing Fuel
        function addTestFuel(amount) {
            fetch('/api/donation/add-fuel', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    amount: amount,
                    type: 'test',
                    user: 'Test Button'
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Refresh mech status immediately
                    checkDonatorMechStatus();
                    // Show brief notification
                    showNotification(`${amount > 0 ? '+' : ''}$${amount} Fuel ${amount > 0 ? 'added' : 'removed'}!`, amount > 0 ? 'success' : 'warning');
                } else {
                    showNotification('Error updating fuel: ' + (data.error || 'Unknown error'), 'danger');
                }
            })
            .catch(error => {
                console.error('Error adding fuel:', error);
                showNotification('Error updating fuel', 'danger');
            });
        }
        
        function resetFuel() {
            if (confirm('Reset fuel to 0â‚¬? This will clear all donations.')) {
                fetch('/api/donation/reset-fuel', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        checkDonatorMechStatus();
                        showNotification('Fuel reset to $0', 'info');
                    } else {
                        showNotification('Error resetting fuel', 'danger');
                    }
                })
                .catch(error => {
                    console.error('Error resetting fuel:', error);
                    showNotification('Error resetting fuel', 'danger');
                });
            }
        }
        
        function showNotification(message, type = 'info') {
            // Create a simple notification (you can style this better)
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3`;
            alertDiv.style.zIndex = '9999';
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.appendChild(alertDiv);
            
            // Auto-remove after 3 seconds
            setTimeout(() => {
                alertDiv.remove();
            }, 3000);
        }
        
        
        // Additional animations for different donation types
        const additionalStyles = `
            @keyframes thankYouFadeOut {
                from { opacity: 1; transform: scale(1); }
                to { opacity: 0; transform: scale(0.9); }
            }
            
            @keyframes thankYouCoffeeShake {
                0%, 100% { transform: rotate(0deg); }
                25% { transform: rotate(-2deg); }
                75% { transform: rotate(2deg); }
            }
            
            @keyframes thankYouPaypalGlow {
                0%, 100% { box-shadow: 0 0 0 rgba(0,112,186,0.5); }
                50% { box-shadow: 0 0 30px rgba(0,112,186,0.8); }
            }
        `;
        
        const styleSheet = document.createElement('style');
        styleSheet.textContent = additionalStyles;
        document.head.appendChild(styleSheet);
        
        // Mech Animation Test Functions
        function testMechAnimation() {
            const donorName = document.getElementById('test-donor-name').value;
            const amount = document.getElementById('test-amount').value;
            const totalDonations = document.getElementById('test-total-donations').value;
            
            const preview = document.getElementById('mech-preview');
            const stats = document.getElementById('mech-stats');
            
            preview.innerHTML = '<div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div>';
            stats.innerHTML = 'Generating animation...';
            
            fetch('/api/test-mech-animation', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    donor_name: donorName,
                    amount: amount,
                    total_donations: parseInt(totalDonations)
                })
            })
            .then(response => {
                console.log('Response status:', response.status);
                console.log('Response type:', response.headers.get('content-type'));
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.blob();
            })
            .then(blob => {
                console.log('Blob size:', blob.size, 'Type:', blob.type);
                const url = URL.createObjectURL(blob);
                preview.innerHTML = `<img src="${url}" alt="Mech Animation" style="max-width: 100%; height: auto; border: 1px solid #666;">`;
                
                // Calculate speed level
                let speedLevel = 1;
                const donations = parseInt(totalDonations);
                if (donations >= 100) speedLevel = 6;
                else if (donations >= 50) speedLevel = 5;
                else if (donations >= 25) speedLevel = 4;
                else if (donations >= 10) speedLevel = 3;
                else if (donations >= 5) speedLevel = 2;
                
                const speedTexts = {
                    1: "Walking ðŸš¶",
                    2: "Jogging ðŸƒ",
                    3: "Running ðŸƒðŸ’¨",
                    4: "Sprinting âš¡",
                    5: "Hyperspeed ðŸš€",
                    6: "LIGHTSPEED! âš¡ðŸ’«"
                };
                
                stats.innerHTML = `
                    <strong>Speed Level:</strong> ${speedLevel}/6 - ${speedTexts[speedLevel]}<br>
                    <strong>File Size:</strong> ~${(blob.size / 1024).toFixed(1)} KB<br>
                    <strong>Type:</strong> ${blob.type}
                `;
            })
            .catch(error => {
                console.error('Mech animation error:', error);
                preview.innerHTML = '<div class="alert alert-danger">Error generating animation: ' + error.message + '<br>Check browser console for details.<br><small>Make sure the spritesheet exists at app/static/animatedmech.png</small></div>';
                stats.innerHTML = 'Error: ' + error.message;
            });
        }
        
        function testSpeedControl() {
            const totalDonations = document.getElementById('test-total-donations').value;
            const preview = document.getElementById('mech-preview');
            const stats = document.getElementById('mech-stats');
            
            // Get speed configuration
            fetch('/api/mech-speed-config', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    total_donations: parseInt(totalDonations)
                })
            })
            .then(response => response.json())
            .then(data => {
                // Create dynamic mech display
                const mechHtml = `
                    <div class="mech-container position-relative" style="height: 100px; overflow: hidden;">
                        <div class="mech-sprite ${data.css_class}" id="dynamic-mech"
                             style="position: absolute; left: -50px; top: 30px; font-size: 30px; 
                                    animation: mech-run ${data.duration}s linear infinite;">
                            ðŸ¤–
                        </div>
                        ${data.effects.sparks ? '<div class="sparks">âš¡âš¡âš¡</div>' : ''}
                    </div>
                    <div class="mt-2">
                        <strong>${data.emoji} ${data.description}</strong><br>
                        <small>Speed Level: ${data.speed_level}/6</small>
                    </div>
                `;
                
                preview.innerHTML = mechHtml;
                
                // Add dynamic CSS
                const css = `
                    @keyframes mech-run {
                        0% { left: -50px; }
                        100% { left: calc(100% + 50px); }
                    }
                    
                    .mech-speed-${data.speed_level} {
                        ${data.effects.glow ? 'filter: drop-shadow(0 0 10px #00ff41);' : ''}
                        ${data.effects.blur ? 'filter: blur(0.5px) brightness(1.2);' : ''}
                    }
                    
                    ${data.effects.shake ? `
                        .mech-speed-${data.speed_level} {
                            animation: mech-run ${data.duration}s linear infinite, 
                                      mech-shake 0.1s ease-in-out infinite;
                        }
                        @keyframes mech-shake {
                            0%, 100% { transform: translateY(0); }
                            50% { transform: translateY(2px); }
                        }
                    ` : ''}
                    
                    ${data.effects.sparks ? `
                        .sparks {
                            position: absolute;
                            top: 20px;
                            left: 50%;
                            animation: spark-flash 0.3s ease-in-out infinite;
                            color: #ffff00;
                            font-size: 20px;
                        }
                        @keyframes spark-flash {
                            0%, 100% { opacity: 0; }
                            50% { opacity: 1; }
                        }
                    ` : ''}
                `;
                
                // Add CSS to page
                let styleElement = document.getElementById('dynamic-mech-styles');
                if (styleElement) styleElement.remove();
                
                styleElement = document.createElement('style');
                styleElement.id = 'dynamic-mech-styles';
                styleElement.textContent = css;
                document.head.appendChild(styleElement);
                
                stats.innerHTML = `
                    <strong>Speed:</strong> ${data.description} (${data.duration}s cycle)<br>
                    <strong>Effects:</strong> ${Object.keys(data.effects).filter(k => data.effects[k]).join(', ') || 'None'}<br>
                    <strong>Total Donations:</strong> ${data.total_donations}
                `;
            })
            .catch(error => {
                console.error('Speed control error:', error);
                preview.innerHTML = '<div class="alert alert-danger">Error: ' + error + '<br>Check browser console for details.</div>';
                stats.innerHTML = 'Error occurred';
            });
        }
        
        function testSimpleMech() {
            const totalDonations = document.getElementById('test-total-donations').value;
            const preview = document.getElementById('mech-preview');
            const stats = document.getElementById('mech-stats');
            
            // Calculate speed level locally
            let speedLevel = 1;
            const donations = parseInt(totalDonations);
            if (donations >= 100) speedLevel = 6;
            else if (donations >= 50) speedLevel = 5;
            else if (donations >= 25) speedLevel = 4;
            else if (donations >= 10) speedLevel = 3;
            else if (donations >= 5) speedLevel = 2;
            
            const speedTexts = {
                1: "Walking ðŸš¶",
                2: "Jogging ðŸƒ",
                3: "Running ðŸƒðŸ’¨",
                4: "Sprinting âš¡",
                5: "Hyperspeed ðŸš€",
                6: "LIGHTSPEED! âš¡ðŸ’«"
            };
            
            // Calculate animation duration (faster = shorter duration)
            const durations = {1: 3.0, 2: 2.0, 3: 1.5, 4: 1.0, 5: 0.6, 6: 0.3};
            const duration = durations[speedLevel];
            
            // Create stationary mech with leg animation
            preview.innerHTML = `
                <div style="position: relative; height: 120px; overflow: hidden; background: linear-gradient(90deg, #2f3136 0%, #36393f 50%, #2f3136 100%); border-radius: 8px;">
                    <!-- Mech Body (stationary) -->
                    <div class="mech-body" style="
                        position: absolute;
                        left: 50%;
                        top: 30px;
                        transform: translateX(-50%);
                        font-size: 40px;
                        animation: mechBob ${duration * 2}s ease-in-out infinite;
                        ${speedLevel >= 5 ? 'filter: drop-shadow(0 0 15px #00ff41) brightness(1.4);' : ''}
                        ${speedLevel >= 6 ? 'text-shadow: 0 0 25px #ffff00; color: gold;' : ''}
                    ">ðŸ¤–</div>
                    
                    <!-- Walking legs animation -->
                    <div class="mech-legs" style="
                        position: absolute;
                        left: 50%;
                        top: 65px;
                        transform: translateX(-50%);
                        font-size: 20px;
                        animation: mechWalk ${duration}s ease-in-out infinite;
                    ">ðŸ‘£</div>
                    
                    <!-- Speed effects -->
                    ${speedLevel >= 3 ? `<div class="speed-lines" style="
                        position: absolute;
                        left: 20%;
                        top: 45px;
                        font-size: 16px;
                        animation: speedLines ${duration * 0.5}s linear infinite;
                        color: #7289da;
                    ">ðŸ’¨ðŸ’¨ðŸ’¨</div>` : ''}
                    
                    <!-- Lightning effects for max speed -->
                    ${speedLevel >= 6 ? '<div style="position: absolute; top: 15px; left: 50%; transform: translateX(-50%); font-size: 25px; animation: flash 0.3s ease-in-out infinite; color: #ffff00;">âš¡ï¸ðŸ’«âš¡ï¸</div>' : ''}
                </div>
                <div class="mt-2 text-center">
                    <strong>${speedTexts[speedLevel]}</strong><br>
                    <small>Level ${speedLevel}/6 - ${duration}s cycle</small>
                </div>
            `;
            
            // Add animation CSS for stationary mech with moving parts
            const css = `
                @keyframes mechBob {
                    0%, 100% { transform: translateX(-50%) translateY(0px); }
                    50% { transform: translateX(-50%) translateY(-3px); }
                }
                @keyframes mechWalk {
                    0% { transform: translateX(-50%) rotate(-5deg); }
                    25% { transform: translateX(-50%) rotate(0deg); }
                    50% { transform: translateX(-50%) rotate(5deg); }
                    75% { transform: translateX(-50%) rotate(0deg); }
                    100% { transform: translateX(-50%) rotate(-5deg); }
                }
                @keyframes speedLines {
                    0% { opacity: 0; transform: translateX(0px); }
                    50% { opacity: 1; transform: translateX(-10px); }
                    100% { opacity: 0; transform: translateX(-20px); }
                }
                @keyframes flash {
                    0%, 100% { opacity: 0; transform: translateX(-50%) scale(1); }
                    50% { opacity: 1; transform: translateX(-50%) scale(1.1); }
                }
            `;
            
            let styleElement = document.getElementById('simple-mech-styles');
            if (styleElement) styleElement.remove();
            
            styleElement = document.createElement('style');
            styleElement.id = 'simple-mech-styles';
            styleElement.textContent = css;
            document.head.appendChild(styleElement);
            
            stats.innerHTML = `
                <strong>Speed Test:</strong> Pure CSS Animation<br>
                <strong>Donations:</strong> ${donations}<br>
                <strong>No API needed!</strong> âœ…
            `;
        }
        
        function simulateDonationBroadcast() {
            const donorName = document.getElementById('test-donor-name').value;
            const amount = document.getElementById('test-amount').value;
            const totalDonations = document.getElementById('test-total-donations').value;
            
            if (confirm(`This will send a test donation broadcast to Discord.\n\nDonor: ${donorName}\nAmount: ${amount}\n\nContinue?`)) {
                fetch('/api/simulate-donation-broadcast', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        donor_name: donorName,
                        amount: amount,
                        total_donations: parseInt(totalDonations)
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showNotification('Test broadcast sent successfully!', 'success');
                    } else {
                        showNotification('Error: ' + data.message, 'danger');
                    }
                })
                .catch(error => {
                    showNotification('Error sending broadcast: ' + error, 'danger');
                });
            }
        }
    </script>

    <p class="text-center" style="color:#ffc107;"><strong>Important:</strong> After saving, the Docker container must be restarted manually (e.g., via Unraid UI or `docker restart ddc`) for the bot to apply all changes!</p>

    {# Flash Messages #}
    {% include '_flash_messages.html' %}

    {# Main form starts here #}
    <form method="POST" id="config-form">

        {# Discord Bot Settings (Token) #}
        {% include '_discord_settings.html' %}

        {# Channel Settings (Guild ID) #}
        {% include '_channel_settings.html' %}

        {# Command Permissions Table #}
        {% include '_permissions_table.html' %}

        {# Server Selection Table #}
        {% include '_server_selection.html' %}

        {# NEW: Task Scheduler Form #}
        <hr class="my-4">
        <div class="mb-3 card p-3">
            {% with active_containers=active_container_names %}
                {% include 'tasks/form.html' %}
            {% endwith %}
        </div>

        {# NEW: Task Scheduler List #}
        <hr class="my-4">
        <div class="mb-3 card p-3">
             {% with active_containers=active_container_names %}
                 {% include 'tasks/list.html' %}
             {% endwith %}
        </div>

        {# Scheduler Section - OLD, replaced by tasks/form.html #}
        {# {% include '_scheduler_section.html' %} #}

        {# Language and Timezone Settings #}
        {% include '_language_timezone_settings.html' %}


        {# NEW: Auth Settings #}
        {% include '_auth_settings.html' %}

        {# Save Button #}
        {% include '_save_button.html' %}

    </form> {# --- End of form --- #}

    {# Heartbeat Section - MOVED OUTSIDE FORM #}
    {% include '_heartbeat_section.html' %}

    <div id="save-notification"></div>

    {% include '_log_section.html' %}

    
    {# Modals #}
    {% include '_spam_protection_modal.html' %}
    {% include '_token_security_modal.html' %}
    {% include '_secure_token_modal.html' %}
    {% include '_advanced_settings_modal.html' %}
    {% include '_diagnostics_modal.html' %}

{% endblock %} {# --- End content block --- #}

{% block scripts %}
    {% include '_scripts.html' %}
{% endblock %} {# --- End scripts block --- #}