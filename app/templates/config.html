{% extends '_base.html' %}

{% block title %}DDC Configuration{% endblock %}

{% block content %}
    <div class="text-center logo-header">
        <img src="{{ url_for('static', filename='ddc_web.png') }}" alt="DDC Logo">
        <div class="ddc-title">
            <span class="neon-text-large" id="neon-ddc">DDC</span>
        </div>
    </div>
    <h2 class="text-center my-3">DockerDiscordControl</h2>
    <p class="text-center lead" style="color:#adb5bd;">Configure your DDC Bot here.</p>

    {# Donation Section #}
    <div class="text-center my-4 donation-section" id="donationSection">
        <p style="color:#adb5bd; margin-bottom: 10px;">If you find DDC helpful, consider supporting its development:</p>
        <span class="d-inline-block mx-2 align-middle">
            <a href="https://buymeacoffee.com/dockerdiscordcontrol" target="_blank" rel="noopener noreferrer" class="bmc-button donation-button" data-donation-type="coffee" title="Buy Me A Coffee">
                <img src="https://cdn.buymeacoffee.com/buttons/v2/default-yellow.png" alt="Buy Me A Coffee" style="height: 40px !important; width: auto !important;">
            </a>
        </span>
        <span class="d-inline-block mx-2 align-middle">
            <a href="https://www.paypal.com/donate/?hosted_button_id=XKVC6SFXU2GW4" target="_blank" rel="noopener noreferrer" class="btn btn-sm donation-button" data-donation-type="paypal" style="background-color: #0070ba; border-color: #0070ba; color: white; height: 40px; line-height: 28px;" title="Donate with PayPal">
               <i class="bi bi-paypal"></i> Donate with PayPal
            </a>
        </span>
        
        <!-- Donator Status Heart -->
        <span class="d-inline-block mx-2 align-middle">
            <div class="donator-heart-container" title="Donator Status">
                <i class="bi bi-heart-fill donator-heart" id="donatorHeart"></i>
            </div>
        </span>
        
        {# Matrix Terminal Thank You Overlay - Hidden by default #}
        <div id="thankYouOverlay" class="matrix-terminal-overlay" style="display: none;">
            <div class="terminal-content">
                <div class="terminal-text">
                    <span id="thankYouText"></span>
                    <span id="cursor" class="cursor">_</span>
                </div>
            </div>
        </div>
    </div>

    <style>
        /* Donation Button Animations */
        .donation-button {
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .donation-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
        }
        
        .donation-button:active {
            transform: scale(0.95);
        }

        /* MATRIX TERMINAL OVERLAY */
        .matrix-terminal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: #000000;
            z-index: 9999;
            display: block;
            font-family: 'Courier New', 'Monaco', 'Menlo', monospace;
            animation: terminalFadeIn 0.3s ease-out;
            overflow: hidden;
        }
        
        @keyframes terminalFadeIn {
            0% { opacity: 0; }
            100% { opacity: 1; }
        }
        
        .terminal-content {
            padding: 20px;
            width: 100%;
            height: 100%;
        }
        
        .terminal-text {
            color: #00ff00;
            font-size: 18px;
            font-weight: bold;
            line-height: 1.2;
            text-align: left;
        }
        
        .cursor {
            color: #00ff00;
            font-size: 18px;
            font-weight: bold;
            animation: cursorBlink 1s infinite;
        }
        
        @keyframes cursorBlink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }
        
        /* Matrix Terminal Complete */
        
        /* Donator Heart Status */
        .donator-heart-container {
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 10px;
        }
        
        .donator-heart {
            font-size: 24px;
            transition: all 0.3s ease;
            cursor: help;
        }
        
        /* Gray state (inactive/old donation) - NO PULSE */
        .donator-heart.inactive {
            color: #6c757d;
            text-shadow: none;
            animation: none; /* No pulsing when inactive */
        }
        
        /* Neon active state (recent donation) - animation set by JavaScript */
        .donator-heart.active {
            color: #36cfff;
            text-shadow: 0 0 10px #36cfff, 0 0 20px #36cfff, 0 0 40px #36cfff;
            /* Animation set dynamically by JavaScript */
        }
        
        /* Fading state - NO PULSE, color set by JavaScript */
        .donator-heart.fading {
            animation: none; /* No pulsing during fade */
            /* Color and text-shadow set dynamically by JavaScript */
        }
        
        /* Dynamic heart pulse animations - generated by JavaScript */
        @keyframes heartPulseFast {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.15); }
        }
        
        @keyframes heartPulseMedium {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        
        @keyframes heartPulseSlow {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.08); }
        }
        
        @keyframes heartPulseVerySlow {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .terminal-text, .cursor { 
                font-size: 14px; 
            }
            .terminal-content {
                padding: 15px;
            }
        }
    </style>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const donationButtons = document.querySelectorAll('.donation-button');
            const thankYouOverlay = document.getElementById('thankYouOverlay');
            const donatorHeart = document.getElementById('donatorHeart');
            
            donationButtons.forEach(button => {
                button.addEventListener('click', function(e) {
                    const donationType = this.getAttribute('data-donation-type');
                    
                    // Record donation click to server
                    fetch('/api/donation/click', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            type: donationType
                        })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            // Store for thank you display
                            localStorage.setItem('ddcDonationClick', JSON.stringify({
                                type: donationType,
                                timestamp: data.timestamp
                            }));
                            
                            // Update heart immediately
                            checkDonatorHeartStatus();
                        }
                    })
                    .catch(error => {
                        console.error('Error recording donation:', error);
                    });
                    
                    // Allow normal link behavior (open in new tab)
                    // No e.preventDefault() - let the browser handle the link normally
                });
            });
            
            // Check for donation return on page focus/load
            function checkForDonationReturn() {
                const donationData = localStorage.getItem('ddcDonationClick');
                if (donationData) {
                    try {
                        const data = JSON.parse(donationData);
                        const timeSinceClick = Date.now() - data.timestamp;
                        
                        // Show thank you if donation was clicked within last 10 minutes
                        if (timeSinceClick < 10 * 60 * 1000) {
                            // Clear the stored data so we don't show it again
                            localStorage.removeItem('ddcDonationClick');
                            
                            // Show the thank you overlay
                            showThankYouOverlay(data.type);
                        }
                    } catch (e) {
                        // Clean up invalid data
                        localStorage.removeItem('ddcDonationClick');
                    }
                }
            }
            
            function showThankYouOverlay(donationType) {
                showMatrixTerminal();
            }
            
            // Check on page load
            checkForDonationReturn();
            
            // Check when window gets focus (user returns from donation page)
            window.addEventListener('focus', function() {
                // Small delay to ensure page is fully focused
                setTimeout(checkForDonationReturn, 500);
            });
            
            // Check on visibility change (better detection for modern browsers)
            document.addEventListener('visibilitychange', function() {
                if (!document.hidden) {
                    setTimeout(checkForDonationReturn, 500);
                }
            });
            
            // Click overlay to close
            thankYouOverlay.addEventListener('click', function() {
                this.style.animation = 'thankYouFadeOut 0.5s ease-out';
                setTimeout(() => {
                    this.style.display = 'none';
                    this.style.animation = '';
                }, 500);
            });
        });
        
        // Matrix Terminal Animation
        
        function showMatrixTerminal() {
            const overlay = document.getElementById('thankYouOverlay');
            const textElement = document.getElementById('thankYouText');
            
            if (!overlay || !textElement) return;
            
            // Show overlay
            overlay.style.display = 'flex';
            textElement.innerHTML = '';
            
            // Timeline: 10 seconds total
            // 0-2s: Cursor blinks
            // 2-4s: Type "Thank You!"
            // 4-6s: Cursor blinks alone 
            // 6-8s: Type "You rule!"
            // 8-10s: Cursor blinks alone
            // 10s: Close
            
            setTimeout(() => {
                typeText(textElement, 'Thank You!', 100, () => {
                    setTimeout(() => {
                        textElement.innerHTML += ' ';
                        typeText(textElement, 'You rule!', 100, () => {
                            setTimeout(() => {
                                overlay.style.display = 'none';
                                textElement.innerHTML = '';
                            }, 2000); // Wait 2s then close
                        });
                    }, 2000); // Wait 2s between messages
                });
            }, 2000); // Wait 2s before first message
        }
        
        function typeText(element, text, speed, callback) {
            let i = 0;
            const timer = setInterval(() => {
                if (i < text.length) {
                    element.innerHTML += text.charAt(i);
                    i++;
                } else {
                    clearInterval(timer);
                    if (callback) callback();
                }
            }, speed);
        }
        
        // Donator Heart Management
        function updateDonatorHeart(donationTimestamp) {
            // No longer storing locally - server handles it
            // Just refresh the heart status from server
            checkDonatorHeartStatus();
        }
        
        function checkDonatorHeartStatus() {
            const heart = document.getElementById('donatorHeart');
            if (!heart) return;
            
            // Fetch donation status from server
            fetch('/api/donation/status')
                .then(response => response.json())
                .then(data => {
                    if (!data.has_donated || data.timestamp === null) {
                        // No donation recorded - gray heart
                        heart.className = 'bi bi-heart-fill donator-heart inactive';
                        heart.style.color = ''; // Reset inline style
                        heart.style.filter = ''; // Reset inline style
                        heart.style.textShadow = ''; // Reset inline style
                        heart.style.animation = '';
                        heart.title = 'Support DDC development ❤️';
                        return;
                    }
                    
                    const daysSinceDonation = data.days_since_donation;
                    
                    if (daysSinceDonation <= 30) {
                // Calculate exact day (0-30)
                const dayNumber = Math.floor(daysSinceDonation);
                const fadePercentage = daysSinceDonation / 30;
                
                // Calculate color transition from #36cfff (neon blue) to #6c757d (gray)
                const startR = 0x36, startG = 0xcf, startB = 0xff; // #36cfff
                const endR = 0x6c, endG = 0x75, endB = 0x7d;       // #6c757d
                
                const currentR = Math.round(startR + (endR - startR) * fadePercentage);
                const currentG = Math.round(startG + (endG - startG) * fadePercentage);
                const currentB = Math.round(startB + (endB - startB) * fadePercentage);
                
                const currentColor = `rgb(${currentR}, ${currentG}, ${currentB})`;
                
                // Reset styles
                heart.style.color = '';
                heart.style.filter = '';
                heart.style.textShadow = '';
                heart.style.animation = '';
                
                if (dayNumber <= 7) {
                    // Days 0-7: Fast pulse + full glow
                    heart.className = 'bi bi-heart-fill donator-heart active';
                    const pulseSpeed = 1 + (dayNumber * 0.2); // 1s to 2.4s
                    heart.style.animation = `heartPulseFast ${pulseSpeed}s ease-in-out infinite`;
                    heart.title = `Fresh donation! Thank you! ❤️ (Day ${dayNumber})`;
                } else if (dayNumber <= 15) {
                    // Days 8-15: Medium pulse + medium glow
                    heart.className = 'bi bi-heart-fill donator-heart fading';
                    heart.style.color = currentColor;
                    
                    // Reduced glow
                    const glowStrength = 1 - ((dayNumber - 7) / 8) * 0.7; // 100% to 30%
                    const glowColor = `rgba(54, 207, 255, ${glowStrength})`;
                    heart.style.textShadow = `0 0 ${10 * glowStrength}px ${glowColor}, 0 0 ${20 * glowStrength}px ${glowColor}`;
                    
                    const pulseSpeed = 2.4 + ((dayNumber - 7) * 0.3); // 2.4s to 4.8s
                    heart.style.animation = `heartPulseMedium ${pulseSpeed}s ease-in-out infinite`;
                    
                    const daysLeft = Math.ceil(30 - daysSinceDonation);
                    heart.title = `Donator status expires in ${daysLeft} days. Thank you! ❤️ (Day ${dayNumber})`;
                } else if (dayNumber <= 28) {
                    // Days 16-28: Slow pulse + no glow
                    heart.className = 'bi bi-heart-fill donator-heart fading';
                    heart.style.color = currentColor;
                    heart.style.textShadow = 'none';
                    
                    const pulseSpeed = 4.8 + ((dayNumber - 15) * 0.4); // 4.8s to 10s
                    heart.style.animation = `heartPulseSlow ${pulseSpeed}s ease-in-out infinite`;
                    
                    const daysLeft = Math.ceil(30 - daysSinceDonation);
                    heart.title = `Donator status expires in ${daysLeft} days. Thank you! ❤️ (Day ${dayNumber})`;
                } else {
                    // Days 29-30: Very slow pulse + almost gray
                    heart.className = 'bi bi-heart-fill donator-heart fading';
                    heart.style.color = currentColor;
                    heart.style.textShadow = 'none';
                    
                    const pulseSpeed = 10 + ((dayNumber - 28) * 5); // 10s to 20s
                    heart.style.animation = `heartPulseVerySlow ${pulseSpeed}s ease-in-out infinite`;
                    
                    const daysLeft = Math.ceil(30 - daysSinceDonation);
                    heart.title = `Donator status expires in ${daysLeft} days. Thank you! ❤️ (Day ${dayNumber})`;
                }
                    } else {
                        // Expired - gray heart
                        heart.className = 'bi bi-heart-fill donator-heart inactive';
                        heart.style.color = ''; // Reset inline style
                        heart.style.filter = ''; // Reset inline style
                        heart.style.textShadow = ''; // Reset inline style
                        heart.style.animation = '';
                        heart.title = 'Support DDC development ❤️';
                    }
                })
                .catch(error => {
                    console.error('Error fetching donation status:', error);
                    // On error, show inactive heart
                    heart.className = 'bi bi-heart-fill donator-heart inactive';
                    heart.style.color = '';
                    heart.style.filter = '';
                    heart.style.textShadow = '';
                    heart.style.animation = '';
                });
        }
        
        // Check heart status on page load
        checkDonatorHeartStatus();
        
        // Update heart status every 5 minutes (server-side tracking now)
        setInterval(checkDonatorHeartStatus, 5 * 60 * 1000);
        
        
        // Additional animations for different donation types
        const additionalStyles = `
            @keyframes thankYouFadeOut {
                from { opacity: 1; transform: scale(1); }
                to { opacity: 0; transform: scale(0.9); }
            }
            
            @keyframes thankYouCoffeeShake {
                0%, 100% { transform: rotate(0deg); }
                25% { transform: rotate(-2deg); }
                75% { transform: rotate(2deg); }
            }
            
            @keyframes thankYouPaypalGlow {
                0%, 100% { box-shadow: 0 0 0 rgba(0,112,186,0.5); }
                50% { box-shadow: 0 0 30px rgba(0,112,186,0.8); }
            }
        `;
        
        const styleSheet = document.createElement('style');
        styleSheet.textContent = additionalStyles;
        document.head.appendChild(styleSheet);
    </script>

    <p class="text-center" style="color:#ffc107;"><strong>Important:</strong> After saving, the Docker container must be restarted manually (e.g., via Unraid UI or `docker restart ddc`) for the bot to apply all changes!</p>

    {# Flash Messages #}
    {% include '_flash_messages.html' %}

    {# Main form starts here #}
    <form method="POST" id="config-form">

        {# Discord Bot Settings (Token) #}
        {% include '_discord_settings.html' %}

        {# Channel Settings (Guild ID) #}
        {% include '_channel_settings.html' %}

        {# Command Permissions Table #}
        {% include '_permissions_table.html' %}

        {# Server Selection Table #}
        {% include '_server_selection.html' %}

        {# NEW: Task Scheduler Form #}
        <hr class="my-4">
        <div class="mb-3 card p-3">
            {% with active_containers=active_container_names %}
                {% include 'tasks/form.html' %}
            {% endwith %}
        </div>

        {# NEW: Task Scheduler List #}
        <hr class="my-4">
        <div class="mb-3 card p-3">
             {% with active_containers=active_container_names %}
                 {% include 'tasks/list.html' %}
             {% endwith %}
        </div>

        {# Scheduler Section - OLD, replaced by tasks/form.html #}
        {# {% include '_scheduler_section.html' %} #}

        {# Language and Timezone Settings #}
        {% include '_language_timezone_settings.html' %}

        {# NEW: Auth Settings #}
        {% include '_auth_settings.html' %}

        {# Save Button #}
        {% include '_save_button.html' %}

    </form> {# --- End of form --- #}

    {# Heartbeat Section - MOVED OUTSIDE FORM #}
    {% include '_heartbeat_section.html' %}

    <div id="save-notification"></div>

    {% include '_log_section.html' %}

    
    {# Modals #}
    {% include '_spam_protection_modal.html' %}
    {% include '_token_security_modal.html' %}
    {% include '_secure_token_modal.html' %}
    {% include '_advanced_settings_modal.html' %}
    {% include '_diagnostics_modal.html' %}

{% endblock %} {# --- End content block --- #}

{% block scripts %}
    {% include '_scripts.html' %}
{% endblock %} {# --- End scripts block --- #}