<hr class="my-4">
<div class="mb-3 card p-3">
    <h4>Container Selection & Bot Permissions</h4>
    <p class="form-text">Select containers (check 'Active') and define the display name and allowed bot actions.</p>
    <div class="table-responsive">
        <table class="table table-dark table-bordered table-hover align-middle">
            <thead>
                <tr>
                    <th scope="col" class="text-center" style="width: 10%;">Order</th>
                    <th scope="col" class="text-center" style="width: 10%;">Active<i class="bi bi-question-circle help-icon" data-bs-toggle="tooltip" data-bs-placement="top" title="Should the bot manage this container?"></i></th>
                    <th scope="col" style="width: 25%;">Container Name / Status / Image</th>
                    <th scope="col" style="width: 20%;">Display Name in Bot<i class="bi bi-question-circle help-icon" data-bs-toggle="tooltip" data-bs-placement="top" title="This name will be shown in the Discord Bot."></i></th>
                    <th scope="col" class="text-center" style="width: 10%;">Status<i class="bi bi-question-circle help-icon" data-bs-toggle="tooltip" data-bs-placement="top" title="Allow bot to fetch CPU/RAM/Uptime?"></i></th>
                    <th scope="col" class="text-center" style="width: 10%;">Start<i class="bi bi-question-circle help-icon" data-bs-toggle="tooltip" data-bs-placement="top" title="Allow bot to start container?"></i></th>
                    <th scope="col" class="text-center" style="width: 10%;">Stop<i class="bi bi-question-circle help-icon" data-bs-toggle="tooltip" data-bs-placement="top" title="Allow bot to stop container?"></i></th>
                    <th scope="col" class="text-center" style="width: 10%;">Restart<i class="bi bi-question-circle help-icon" data-bs-toggle="tooltip" data-bs-placement="top" title="Allow bot to restart container?"></i></th>
                    <th scope="col" class="text-center" style="width: 5%;">Info</th>
                </tr>
            </thead>
            <tbody id="docker-container-list">
                {% if all_containers %}
                    {% for container in all_containers %}
                        {% set server_config = configured_servers.get(container.name, {}) %}
                        {% set is_selected = container.name in configured_servers %}
                        <tr data-container-id="{{ container.id }}" data-container-name="{{ container.name }}">
                            <td class="text-center align-middle">
                                <span class="order-number me-1"></span>
                                <button type="button" class="btn btn-sm btn-outline-secondary move-up-btn requires-restart" title="Move Up (+)" {% if loop.first %}disabled{% endif %}>
                                    +
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-secondary move-down-btn requires-restart" title="Move Down (-)" {% if loop.last %}disabled{% endif %}>
                                    -
                                </button>
                            </td>
                            <td class="text-center">
                                <div class="form-check">
                                    <input class="form-check-input server-checkbox requires-restart" type="checkbox" name="selected_servers" value="{{ container.name }}" id="select_{{ container.id }}" {% if is_selected %}checked{% endif %}>
                                    <label class="form-check-label visually-hidden" for="select_{{ container.id }}">Select</label>
                                </div>
                            </td>
                            <td>
                                <code class="text-info">{{ container.name }}</code><br>
                                <small class="text-light">Status: {{ container.status }}<br>Image: {{ container.image }}</small>
                            </td>
                            <td>
                                <input type="text" class="form-control form-control-sm display-name-input" 
                                       name="display_name_{{ container.name }}" 
                                       value="{{ configured_servers.get(container.name, {}).get('display_name', container.name) }}" 
                                       placeholder="Display Name for Bot" {% if not is_selected %}disabled{% endif %}>
                            </td>
                            <td class="text-center">
                                <div class="form-check">
                                    <input class="form-check-input action-checkbox" type="checkbox" name="allow_status_{{ container.name }}" value="1" id="status_{{ container.id }}" {% if 'status' in configured_servers.get(container.name, {}).get('allowed_actions', []) %}checked{% endif %} {% if not is_selected %}disabled{% endif %}>
                                    <label class="form-check-label visually-hidden" for="status_{{ container.id }}">Status</label>
                                </div>
                            </td>
                            <td class="text-center">
                                <div class="form-check">
                                    <input class="form-check-input action-checkbox" type="checkbox" name="allow_start_{{ container.name }}" value="1" id="start_{{ container.id }}" {% if 'start' in configured_servers.get(container.name, {}).get('allowed_actions', []) %}checked{% endif %} {% if not is_selected %}disabled{% endif %}>
                                    <label class="form-check-label visually-hidden" for="start_{{ container.id }}">Start</label>
                                </div>
                            </td>
                            <td class="text-center">
                                <div class="form-check">
                                    <input class="form-check-input action-checkbox" type="checkbox" name="allow_stop_{{ container.name }}" value="1" id="stop_{{ container.id }}" {% if 'stop' in configured_servers.get(container.name, {}).get('allowed_actions', []) %}checked{% endif %} {% if not is_selected %}disabled{% endif %}>
                                    <label class="form-check-label visually-hidden" for="stop_{{ container.id }}">Stop</label>
                                </div>
                            </td>
                            <td class="text-center">
                                <div class="form-check">
                                    <input class="form-check-input action-checkbox" type="checkbox" name="allow_restart_{{ container.name }}" value="1" id="restart_{{ container.id }}" {% if 'restart' in configured_servers.get(container.name, {}).get('allowed_actions', []) %}checked{% endif %} {% if not is_selected %}disabled{% endif %}>
                                    <label class="form-check-label visually-hidden" for="restart_{{ container.id }}">Restart</label>
                                </div>
                            </td>
                            <td class="text-center">
                                <button type="button" class="btn btn-sm btn-info info-btn" data-container="{{ container.name }}" title="Edit Info" {% if not is_selected %}disabled{% endif %}>
                                    <i class="bi bi-info-circle"></i>
                                </button>
                            </td>
                        </tr>
                        {# Hidden inputs for container info configuration #}
                        {% set info_config = container_info_data.get(container.name, {}) %}
                        <input type="hidden" name="info_enabled_{{ container.name }}" value="{% if info_config.get('enabled', False) %}1{% else %}0{% endif %}">
                        <input type="hidden" name="info_show_ip_{{ container.name }}" value="{% if info_config.get('show_ip', False) %}1{% else %}0{% endif %}">
                        <input type="hidden" name="info_custom_ip_{{ container.name }}" value="{{ info_config.get('custom_ip', '') }}">
                        <textarea name="info_custom_text_{{ container.name }}" style="display:none;">{{ info_config.get('custom_text', '') }}</textarea>
                    {% endfor %}
                {% elif cache_error %}
                    <tr><td colspan="9"><div class="alert alert-warning m-0">{{ cache_error }}</div></td></tr>
                {% else %}
                     <tr><td colspan="9"><div class="alert alert-info m-0">No Docker containers found.</div></td></tr>
                {% endif %}
            </tbody>
        </table>
    </div>

    {# Cache Update Timestamp #}
    <div class="text-start mt-2">
        <small class="text-muted">
            Container list last updated:
            <span id="cache-timestamp" data-timestamp="{{ last_cache_update|default(docker_cache.global_timestamp|default('N/A')) }}">
                {{ formatted_timestamp|default('Never') }}
            </span>
            <button type="button" class="btn btn-sm btn-outline-secondary ms-2" id="refresh-docker-list">
                <i class="bi bi-arrow-repeat"></i> Refresh
            </button>
        </small>
        <div class="form-text mt-1" id="cache-status-text" style="display: none;">Container list cache is initializing...</div>
    </div>
</div>

{# Container Info Modal #}
<div class="modal fade" id="containerInfoModal" tabindex="-1" aria-labelledby="containerInfoModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content bg-dark text-light">
            <div class="modal-header">
                <h5 class="modal-title" id="containerInfoModalLabel">
                    <i class="bi bi-info-circle"></i> Container Info Configuration
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="containerInfoForm">
                    <input type="hidden" id="modal-container-name" name="container_name">
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" name="info_enabled" value="1" id="modal-info-enabled">
                                <label class="form-check-label" for="modal-info-enabled">
                                    Enable Info Button
                                </label>
                            </div>
                            
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" name="info_show_ip" value="1" id="modal-info-show-ip">
                                <label class="form-check-label" for="modal-info-show-ip">
                                    Show IP Address
                                </label>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="mb-2">
                                <label for="modal-info-custom-ip" class="form-label">Custom IP/URL Override</label>
                                <input type="text" class="form-control form-control-sm" name="info_custom_ip" id="modal-info-custom-ip" placeholder="e.g., mydomain.com:7777">
                                <div class="form-text">Leave empty to use auto-detected public IP</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="modal-info-custom-text" class="form-label">Custom Info Text</label>
                        <textarea class="form-control" name="info_custom_text" id="modal-info-custom-text" rows="4" maxlength="250" placeholder="Password: mypass123&#10;Mods: ModName1, ModName2&#10;Max Players: 8"></textarea>
                        <div class="form-text">
                            <span id="modal-char-counter">0</span>/250 characters
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" id="saveContainerInfo">Save Changes</button>
            </div>
        </div>
    </div>
</div> 