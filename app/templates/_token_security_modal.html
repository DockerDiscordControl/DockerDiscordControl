<!-- Token Security Modal -->
<div class="modal fade" id="tokenSecurityModal" tabindex="-1" aria-labelledby="tokenSecurityModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="tokenSecurityModalLabel">
                    <i class="bi bi-shield-lock"></i> Bot Token Security Status
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Security Status Content -->
                <div id="tokenSecurityContent">
                    <div class="text-center">
                        <div class="spinner-border spinner-border-sm" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <span class="ms-2">Checking token security status...</span>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="refreshTokenStatusModal()">
                    <i class="bi bi-arrow-clockwise"></i> Refresh Status
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// Token security modal management
async function refreshTokenStatusModal() {
    const contentDiv = document.getElementById('tokenSecurityContent');
    
    // Show loading state
    contentDiv.innerHTML = `
        <div class="text-center">
            <div class="spinner-border spinner-border-sm" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <span class="ms-2">Checking token security status...</span>
        </div>
    `;
    
    try {
        const response = await fetch('/api/token-security-status');
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        displayTokenStatusModal(data);
        
    } catch (error) {
        console.error('Error fetching token status:', error);
        contentDiv.innerHTML = `
            <div class="alert alert-danger mb-0">
                <i class="bi bi-exclamation-triangle"></i>
                <strong>Error:</strong> Could not check token security status.
                <br><small>${error.message}</small>
            </div>
        `;
    }
}

function displayTokenStatusModal(status) {
    const contentDiv = document.getElementById('tokenSecurityContent');
    
    let html = '';
    
    // Main status indicator (larger in modal)
    if (status.environment_token_used) {
        html += `
            <div class="alert alert-success mb-4">
                <h6><i class="bi bi-check-circle-fill"></i> Excellent Security!</h6>
                <p class="mb-0">Using environment variable DISCORD_BOT_TOKEN. This is the most secure method.</p>
            </div>
        `;
    } else if (status.is_encrypted && status.token_exists) {
        html += `
            <div class="alert alert-success mb-4">
                <h6><i class="bi bi-shield-check"></i> Good Security!</h6>
                <p class="mb-0">Bot token is encrypted in config file using your admin password.</p>
            </div>
        `;
    } else if (status.token_exists && !status.is_encrypted) {
        html += `
            <div class="alert alert-warning mb-4">
                <h6><i class="bi bi-exclamation-triangle"></i> Security Risk!</h6>
                <p class="mb-0">Bot token is stored in plaintext. Consider encrypting it for better security.</p>
            </div>
        `;
    } else {
        html += `
            <div class="alert alert-info mb-4">
                <h6><i class="bi bi-info-circle"></i> No Token Configured</h6>
                <p class="mb-0">Please configure your Discord bot token to enable DDC.</p>
            </div>
        `;
    }
    
    // Environment variable upgrade warning (always visible unless already using env var)
    if (!status.environment_token_used) {
        html += `
            <div class="alert alert-warning border-warning mb-4" style="border-left: 4px solid #ffc107;">
                <div class="d-flex align-items-start">
                    <i class="bi bi-exclamation-triangle-fill text-warning me-3" style="font-size: 1.5rem; margin-top: 0.125rem;"></i>
                    <div class="flex-grow-1">
                        <h6 class="alert-heading mb-2">
                            <strong>üåü SECURITY UPGRADE AVAILABLE</strong>
                        </h6>
                        <p class="mb-3">
                            <strong>Recommended:</strong> Migrate to environment variable for enhanced security. 
                            This is the industry standard for Docker deployments and provides better protection than encrypted config files.
                        </p>
                        <div class="mb-3">
                            <strong>Benefits:</strong>
                            <ul class="mb-0 mt-1">
                                <li>‚úÖ Higher security than encrypted config files</li>
                                <li>‚úÖ Works with Unraid, Docker Compose, Kubernetes</li>
                                <li>‚úÖ Token never stored in files or backups</li>
                                <li>‚úÖ Industry standard for containerized applications</li>
                            </ul>
                        </div>
                        <div class="d-grid gap-2 d-md-flex">
                            <button type="button" class="btn btn-warning btn-sm" onclick="showMigrationHelpModal()">
                                <i class="bi bi-arrow-up-right-circle"></i> <strong>Migrate Now</strong>
                            </button>
                            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="showSecurityGuideModal()">
                                <i class="bi bi-info-circle"></i> Learn More
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }
    
    // Security details grid
    html += '<div class="row mb-4">';
    html += '<div class="col-md-6">';
    html += '<h6>Security Status:</h6>';
    html += '<div class="list-group list-group-flush">';
    
    const checks = [
        {
            label: 'Environment Variable',
            status: status.environment_token_used,
            icon: status.environment_token_used ? 'check-circle text-success' : 'circle text-muted'
        },
        {
            label: 'Token Encryption',
            status: status.is_encrypted,
            icon: status.is_encrypted ? 'check-circle text-success' : (status.token_exists ? 'x-circle text-warning' : 'circle text-muted')
        },
        {
            label: 'Admin Password Set',
            status: status.password_hash_available,
            icon: status.password_hash_available ? 'check-circle text-success' : 'x-circle text-warning'
        },
        {
            label: 'Token Configured',
            status: status.token_exists,
            icon: status.token_exists ? 'check-circle text-success' : 'x-circle text-danger'
        }
    ];
    
    checks.forEach(check => {
        html += `
            <div class="list-group-item border-0 px-0 py-2">
                <i class="bi bi-${check.icon}"></i>
                <span class="ms-2">${check.label}</span>
            </div>
        `;
    });
    
    html += '</div></div>';
    
    // Recommendations
    if (status.recommendations && status.recommendations.length > 0) {
        html += '<div class="col-md-6">';
        html += '<h6>Recommendations:</h6>';
        html += '<div class="list-group list-group-flush">';
        
        status.recommendations.forEach(recommendation => {
            const iconMap = {
                '‚úÖ': 'check-circle text-success',
                '‚ö†Ô∏è': 'exclamation-triangle text-warning',
                'üîí': 'lock text-primary',
                'üí°': 'lightbulb text-info',
                '‚ùå': 'x-circle text-danger'
            };
            
            const emoji = recommendation.charAt(0);
            const icon = iconMap[emoji] || 'info-circle';
            const text = recommendation.replace(/^[‚úÖ‚ö†Ô∏èüîíüí°‚ùå]\s*/, '');
            
            html += `
                <div class="list-group-item border-0 px-0 py-2">
                    <i class="bi bi-${icon}"></i>
                    <span class="ms-2">${text}</span>
                </div>
            `;
        });
        
        html += '</div></div>';
    }
    
    html += '</div>';
    
    // Action buttons (larger in modal)
    if (!status.environment_token_used) {
        html += '<div class="border-top pt-4">';
        html += '<h6>Available Actions:</h6>';
        html += '<div class="d-grid gap-2 d-md-block">';
        
        if (status.token_exists && !status.is_encrypted && status.can_encrypt) {
            html += `
                <button type="button" class="btn btn-success me-2" onclick="encryptTokenModal()">
                    <i class="bi bi-lock"></i> Encrypt Token Now
                </button>
            `;
        }
        
        if (status.is_encrypted) {
            html += `
                <button type="button" class="btn btn-info me-2" onclick="showMigrationHelpModal()">
                    <i class="bi bi-arrow-up-right-circle"></i> Migrate to Environment Variable
                </button>
            `;
        }
        
        html += `
            <button type="button" class="btn btn-outline-secondary" onclick="showSecurityGuideModal()">
                <i class="bi bi-book"></i> Security Documentation
            </button>
        `;
        
        html += '</div></div>';
    }
    
    contentDiv.innerHTML = html;
}

async function encryptTokenModal() {
    if (!confirm('Encrypt the bot token using your admin password? This will make the token more secure.')) {
        return;
    }
    
    try {
        const response = await fetch('/api/encrypt-token', { 
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        });
        
        const result = await response.json();
        
        if (result.success) {
            alert('‚úÖ Token encrypted successfully!');
            refreshTokenStatusModal();
        } else {
            alert(`‚ùå Encryption failed: ${result.error || 'Unknown error'}`);
        }
    } catch (error) {
        alert(`‚ùå Encryption failed: ${error.message}`);
    }
}

async function showMigrationHelpModal() {
    try {
        const response = await fetch('/api/migration-help');
        const result = await response.json();
        
        if (result.success && result.token) {
            // üîí SECURITY FIX: Use secure modal instead of alert()
            showSecureTokenModal(result.token);
        } else {
            alert(`‚ùå Migration failed: ${result.error || 'Could not decrypt token'}`);
        }
    } catch (error) {
        alert(`‚ùå Migration failed: ${error.message}`);
    }
}

function showSecurityGuideModal() {
    // Open security documentation
    window.open('/static/SECURITY.md', '_blank');
}

// Initialize modal when opened
document.addEventListener('DOMContentLoaded', function() {
    const tokenSecurityModal = document.getElementById('tokenSecurityModal');
    if (tokenSecurityModal) {
        tokenSecurityModal.addEventListener('shown.bs.modal', function () {
            refreshTokenStatusModal();
        });
    }
});
</script>