<!-- Advanced Settings Modal -->
<div class="modal fade" id="advancedSettingsModal" tabindex="-1" aria-labelledby="advancedSettingsModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content bg-dark text-light">
      <div class="modal-header">
        <h5 class="modal-title" id="advancedSettingsModalLabel">
          <i class="bi bi-sliders"></i> Advanced Settings
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="alert alert-info" role="alert">
          <i class="bi bi-info-circle"></i> Changes apply on next restart. Defaults are shown as placeholders.
        </div>
        {% include '_advanced_settings.html' %}
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary" id="saveAdvancedSettings">
          <i class="bi bi-save"></i> Save Advanced Settings
        </button>
      </div>
    </div>
  </div>
  <script>
    // Advanced Settings Modal JavaScript
    document.addEventListener('DOMContentLoaded', function() {
      const modal = document.getElementById('advancedSettingsModal');
      const saveBtn = document.getElementById('saveAdvancedSettings');
      let currentSettings = {};
      
      // Load current settings when modal is shown
      modal.addEventListener('show.bs.modal', function() {
        loadAdvancedSettings();
      });
      
      // Save button handler
      if (saveBtn) {
        saveBtn.addEventListener('click', function() {
          saveAdvancedSettings();
        });
      }
      
      // Add input validation listeners
      const inputs = modal.querySelectorAll('input[type="number"], input[type="checkbox"]');
      inputs.forEach(input => {
        input.addEventListener('input', validateInput);
        input.addEventListener('blur', validateInput);
      });
      
      function loadAdvancedSettings() {
        // Show loading state
        const saveBtn = document.getElementById('saveAdvancedSettings');
        if (saveBtn) {
          saveBtn.disabled = true;
          saveBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> Loading...';
        }
        
        fetch('{{ url_for("main_bp.get_advanced_settings") }}')
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              currentSettings = data.settings;
              populateForm(data.settings);
            } else {
              showError('Failed to load settings: ' + (data.error || 'Unknown error'));
            }
          })
          .catch(error => {
            console.error('Error loading advanced settings:', error);
            showError('Failed to load settings. Please try again.');
          })
          .finally(() => {
            // Restore save button
            if (saveBtn) {
              saveBtn.disabled = false;
              saveBtn.innerHTML = '<i class="bi bi-save"></i> Save Advanced Settings';
            }
          });
      }
      
      function populateForm(settings) {
        // Populate form fields with current values
        Object.entries(settings).forEach(([key, value]) => {
          const field = document.getElementById('env_DDC_' + key.toUpperCase());
          if (field) {
            if (field.type === 'checkbox') {
              field.checked = value === 'true';
            } else {
              field.value = value || '';
            }
            // Remove any validation errors
            clearFieldValidation(field);
          }
        });
      }
      
      function saveAdvancedSettings() {
        // Collect form data
        const formData = new FormData();
        const settings = {};
        const inputs = modal.querySelectorAll('input[type="number"], input[type="checkbox"]');
        
        inputs.forEach(input => {
          const fieldName = input.id.replace('env_DDC_', '').toLowerCase();
          if (input.type === 'checkbox') {
            settings[fieldName] = input.checked;
          } else {
            settings[fieldName] = input.value.trim();
          }
        });
        
        // Show loading state
        const saveBtn = document.getElementById('saveAdvancedSettings');
        if (saveBtn) {
          saveBtn.disabled = true;
          saveBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> Saving...';
        }
        
        // Clear previous alerts
        clearAlerts();
        
        fetch('{{ url_for("main_bp.save_advanced_settings") }}', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ settings: settings })
        })
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              showSuccess(data.message || 'Advanced settings saved successfully!');
              // Close modal after short delay
              setTimeout(() => {
                const modalEl = document.getElementById('advancedSettingsModal');
                const instance = bootstrap.Modal.getInstance(modalEl);
                if (instance) instance.hide();
              }, 1500);
            } else {
              if (data.errors && Array.isArray(data.errors)) {
                showValidationErrors(data.errors);
              } else {
                showError(data.error || 'Failed to save settings');
              }
            }
          })
          .catch(error => {
            console.error('Error saving advanced settings:', error);
            showError('Failed to save settings. Please try again.');
          })
          .finally(() => {
            // Restore save button
            if (saveBtn) {
              saveBtn.disabled = false;
              saveBtn.innerHTML = '<i class="bi bi-save"></i> Save Advanced Settings';
            }
          });
      }
      
      function validateInput(event) {
        const input = event.target;
        if (input.type === 'number' && input.value.trim()) {
          const value = parseInt(input.value);
          const min = parseInt(input.getAttribute('min') || '0');
          const max = parseInt(input.getAttribute('max') || '999999');
          
          clearFieldValidation(input);
          
          if (isNaN(value)) {
            setFieldValidation(input, 'Must be a valid number');
          } else if (value < min || value > max) {
            setFieldValidation(input, `Value must be between ${min} and ${max}`);
          }
        }
      }
      
      function setFieldValidation(field, message) {
        field.classList.add('is-invalid');
        let feedback = field.parentNode.querySelector('.invalid-feedback');
        if (!feedback) {
          feedback = document.createElement('div');
          feedback.className = 'invalid-feedback';
          field.parentNode.appendChild(feedback);
        }
        feedback.textContent = message;
      }
      
      function clearFieldValidation(field) {
        field.classList.remove('is-invalid');
        const feedback = field.parentNode.querySelector('.invalid-feedback');
        if (feedback) {
          feedback.remove();
        }
      }
      
      function showSuccess(message) {
        const alertDiv = document.createElement('div');
        alertDiv.className = 'alert alert-success alert-dismissible fade show';
        alertDiv.innerHTML = `
          <i class="bi bi-check-circle"></i> ${message}
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        modal.querySelector('.modal-body').insertBefore(alertDiv, modal.querySelector('.modal-body').firstChild);
      }
      
      function showError(message) {
        const alertDiv = document.createElement('div');
        alertDiv.className = 'alert alert-danger alert-dismissible fade show';
        alertDiv.innerHTML = `
          <i class="bi bi-exclamation-triangle"></i> ${message}
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        modal.querySelector('.modal-body').insertBefore(alertDiv, modal.querySelector('.modal-body').firstChild);
      }
      
      function showValidationErrors(errors) {
        const alertDiv = document.createElement('div');
        alertDiv.className = 'alert alert-danger alert-dismissible fade show';
        const errorList = errors.map(error => `<li>${error}</li>`).join('');
        alertDiv.innerHTML = `
          <i class="bi bi-exclamation-triangle"></i> Please fix the following errors:
          <ul class="mb-0 mt-2">${errorList}</ul>
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        modal.querySelector('.modal-body').insertBefore(alertDiv, modal.querySelector('.modal-body').firstChild);
      }
      
      function clearAlerts() {
        const alerts = modal.querySelectorAll('.alert:not(.alert-info)');
        alerts.forEach(alert => alert.remove());
      }
    });
  </script>
</div>

