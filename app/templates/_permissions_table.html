<hr class="my-4">
<div class="mb-3 card p-3">
    <h4>Command Permissions</h4>
    <p class="form-text">Configure which commands can be used in which channels. The control channel always allows all commands.</p>
    <div class="d-flex justify-content-between mb-3">
        <button type="button" class="btn btn-success btn-sm" onclick="addChannelRow()">+ Add Channel</button>
        <button type="button" class="btn btn-warning btn-sm" onclick="openAdminModal()">ðŸ‘¤ Admin Users</button>
    </div>
    <table class="table table-dark table-sm small table-hover" id="command-permissions-table">
        <thead>
            <tr>
                <th scope="col" style="width: 12%;">Channel Name<i class="bi bi-question-circle help-icon" data-bs-toggle="tooltip" title="A display name to help you remember which channel this is"></i></th>
                <th scope="col" style="width: 12%;">Channel ID<i class="bi bi-question-circle help-icon" data-bs-toggle="tooltip" title="The Discord channel ID. Enable Developer Mode in Discord, then right-click the channel and select Copy ID"></i></th>
                <th scope="col" class="text-center" style="width: 7%;" data-bs-toggle="tooltip" title="Allows /serverstatus and /ss commands">/serverstatus<i class="bi bi-question-circle help-icon"></i></th>
                <th scope="col" class="text-center" style="width: 7%;" data-bs-toggle="tooltip" title="Allows /control command (automatically enables /command)">/control<i class="bi bi-question-circle help-icon"></i></th>
                <th scope="col" class="text-center" style="width: 7%;" data-bs-toggle="tooltip" title="Allows all task commands (/task_once, /task_daily, etc.)...">/task<i class="bi bi-question-circle help-icon"></i></th>
                <th scope="col" class="text-center border-start border-secondary" style="width: 7%;" data-bs-toggle="tooltip" title="Allows container info button display and editing">Info<i class="bi bi-question-circle help-icon"></i></th>
                <th scope="col" class="text-center" style="width: 8%;" data-bs-toggle="tooltip" title="Post initial status/control messages on bot start?">Initial<i class="bi bi-question-circle help-icon"></i></th>
                <th scope="col" class="text-center" style="width: 9%; border-left: 3px solid #0dcaf0;" data-bs-toggle="tooltip" title="Enable periodic status updates?">Refresh<i class="bi bi-question-circle help-icon"></i></th>
                <th scope="col" style="width: 7%;" data-bs-toggle="tooltip" title="Update status messages every X minutes (if refresh is enabled).">Minutes</th>
                <th scope="col" class="text-center" style="width: 9%; border-left: 3px solid #0dcaf0;" data-bs-toggle="tooltip" title="If enabled, checks if the bot's last activity in the channel is older than the timeout. If yes, AND the actual last message in the channel is NOT from the bot, the bot will delete its old messages and post fresh ones to bring them back to the bottom.">Recreate<i class="bi bi-question-circle help-icon"></i></th>
                <th scope="col" style="width: 7%;" data-bs-toggle="tooltip" title="Regenerate messages after X minutes of inactivity (if recreate is enabled). Minimum 1.">Minutes</th>
                <th scope="col" class="text-center" style="width: 5%; border-left: 3px solid #0dcaf0;">Action</th>
            </tr>
        </thead>
        <tbody>
            {% set channel_permissions = config.get('channel_permissions', {}) %}
            {% set defaults = config.get('default_channel_permissions', DEFAULT_CONFIG['default_channel_permissions']) %}
            {% if not channel_permissions %}
                 <tr id="channel-row-1">
                    <td><input type="text" class="form-control form-control-sm" name="channel_name_1" placeholder="Channel Name"></td>
                    <td>
                        <input type="text" class="form-control form-control-sm" name="channel_id_1" placeholder="Channel ID">
                         <input type="hidden" name="old_channel_id_1" value="">
                    </td>
                    <td class="text-center">
                        <div class="form-check">
                            <input class="form-check-input cmd-serverstatus" type="checkbox" name="cmd_serverstatus_1" value="1" {% if defaults.get('commands', {}).get('serverstatus', False) %}checked{% endif %}>
                            <label class="form-check-label visually-hidden">/serverstatus</label>
                        </div>
                    </td>
                    <td class="text-center">
                         <div class="form-check">
                            <input class="form-check-input cmd-control" type="checkbox" name="cmd_control_1" value="1" {% if defaults.get('commands', {}).get('control', False) %}checked{% endif %}>
                             <label class="form-check-label visually-hidden">/control</label>
                        </div>
                    </td>
                    <td class="text-center">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="cmd_schedule_1" value="1" {% if defaults.get('commands', {}).get('schedule', False) %}checked{% endif %}>
                            <label class="form-check-label visually-hidden">/task</label>
                        </div>
                    </td>
                    <td class="text-center border-start border-secondary">
                        <div class="form-check">
                            <input class="form-check-input cmd-info" type="checkbox" name="cmd_info_1" value="1">
                            <label class="form-check-label visually-hidden">Info</label>
                        </div>
                    </td>
                    <td class="text-center">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="post_initial_1" value="1" {% if defaults.get('post_initial', False) %}checked{% endif %}>
                            <label class="form-check-label visually-hidden">Initial</label>
                        </div>
                    </td>
                    <td class="text-center" style="border-left: 3px solid #0dcaf0;">
                        <div class="form-check">
                            <input class="form-check-input auto-refresh-checkbox" type="checkbox" name="enable_auto_refresh_1" value="1" {% if defaults.get('enable_auto_refresh', False) %}checked{% endif %} data-target-input=".interval-minutes-input">
                            <label class="form-check-label visually-hidden">Refresh</label>
                        </div>
                    </td>
                    <td><input type="number" class="form-control form-control-sm interval-minutes-input" name="update_interval_minutes_1" value="{{ defaults.get('update_interval_minutes', 1) }}" min="1" style="width: 60px;" {% if not defaults.get('enable_auto_refresh', False) %}disabled{% endif %}></td>
                    <td class="text-center" style="border-left: 3px solid #0dcaf0;">
                        <div class="form-check">
                            <input class="form-check-input recreate-checkbox" type="checkbox" name="recreate_messages_on_inactivity_1" value="1" {% if defaults.get('recreate_messages_on_inactivity', False) %}checked{% endif %} data-target-input=".inactivity-minutes-input">
                            <label class="form-check-label visually-hidden">Recreate on Inactivity</label>
                        </div>
                    </td>
                    <td><input type="number" class="form-control form-control-sm inactivity-minutes-input" name="inactivity_timeout_minutes_1" value="{{ defaults.get('inactivity_timeout_minutes', 1) }}" min="1" style="width: 60px;" {% if not defaults.get('recreate_messages_on_inactivity', False) %}disabled{% endif %}></td>
                    <td class="text-center" style="border-left: 3px solid #0dcaf0;">
                        <button type="button" class="btn btn-sm btn-danger remove-channel-btn" data-row-id="channel-row-1">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                </tr>
            {% else %}
                {% for channel_id, channel_data in channel_permissions.items() %}
                 <tr id="channel-row-{{ loop.index }}">
                    <td><input type="text" class="form-control form-control-sm" name="channel_name_{{ loop.index }}" value="{{ channel_data.name }}" placeholder="Channel Name"></td>
                    <td>
                        <input type="text" class="form-control form-control-sm" name="channel_id_{{ loop.index }}" value="{{ channel_id }}" placeholder="Channel ID" id="channel_id_{{ loop.index }}">
                         <input type="hidden" name="old_channel_id_{{ loop.index }}" value="{{ channel_id }}">
                    </td>
                    <td class="text-center">
                        <div class="form-check">
                            <input class="form-check-input cmd-serverstatus" type="checkbox" name="cmd_serverstatus_{{ loop.index }}" value="1" {% if channel_data.commands.serverstatus or channel_data.commands.ss %}checked{% endif %}>
                            <label class="form-check-label visually-hidden">/serverstatus</label>
                        </div>
                    </td>
                    <td class="text-center">
                        <div class="form-check">
                            <input class="form-check-input cmd-control" type="checkbox" name="cmd_control_{{ loop.index }}" value="1" {% if channel_data.commands.control %}checked{% endif %}>
                            <label class="form-check-label visually-hidden">/control</label>
                        </div>
                    </td>
                    <td class="text-center">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="cmd_schedule_{{ loop.index }}" value="1" {% if channel_data.commands.schedule %}checked{% endif %}>
                            <label class="form-check-label visually-hidden">/task</label>
                        </div>
                    </td>
                    <td class="text-center border-start border-secondary">
                        <div class="form-check">
                            <input class="form-check-input cmd-info" type="checkbox" name="cmd_info_{{ loop.index }}" value="1" {% if channel_data.commands.info %}checked{% endif %}>
                            <label class="form-check-label visually-hidden">Info</label>
                        </div>
                    </td>
                    <td class="text-center">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="post_initial_{{ loop.index }}" value="1" {% if channel_data.post_initial %}checked{% endif %}>
                            <label class="form-check-label visually-hidden">Initial</label>
                        </div>
                    </td>
                    <td class="text-center" style="border-left: 3px solid #0dcaf0;">
                        <div class="form-check">
                            <input class="form-check-input auto-refresh-checkbox" type="checkbox" name="enable_auto_refresh_{{ loop.index }}" value="1" {% set is_ar_checked = channel_data.get('enable_auto_refresh', defaults.get('enable_auto_refresh', False)) %}{% if is_ar_checked %}checked{% endif %} data-target-input=".interval-minutes-input">
                            <label class="form-check-label visually-hidden">Refresh</label>
                        </div>
                    </td>
                    <td><input type="number" class="form-control form-control-sm interval-minutes-input" name="update_interval_minutes_{{ loop.index }}" value="{{ channel_data.get('update_interval_minutes', defaults.get('update_interval_minutes', 1)) }}" min="1" style="width: 60px;" {% if not is_ar_checked %}disabled{% endif %}></td>
                    <td class="text-center" style="border-left: 3px solid #0dcaf0;">
                        <div class="form-check">
                            <input class="form-check-input recreate-checkbox" type="checkbox" name="recreate_messages_on_inactivity_{{ loop.index }}" value="1" {% set is_ri_checked = channel_data.get('recreate_messages_on_inactivity', defaults.get('recreate_messages_on_inactivity', False)) %}{% if is_ri_checked %}checked{% endif %} data-target-input=".inactivity-minutes-input">
                            <label class="form-check-label visually-hidden">Recreate on Inactivity</label>
                        </div>
                    </td>
                    <td><input type="number" class="form-control form-control-sm inactivity-minutes-input" name="inactivity_timeout_minutes_{{ loop.index }}" value="{{ channel_data.get('inactivity_timeout_minutes', defaults.get('inactivity_timeout_minutes', 1)) }}" min="1" style="width: 60px;" {% if not is_ri_checked %}disabled{% endif %}></td>
                    <td class="text-center" style="border-left: 3px solid #0dcaf0;">
                         <button type="button" class="btn btn-sm btn-danger remove-channel-btn" data-row-id="channel-row-{{ loop.index }}">
                             <i class="bi bi-trash"></i>
                         </button>
                     </td>
                 </tr>
                 {% endfor %}
             {% endif %}
         </tbody>
     </table>
</div>

<!-- Admin Users Modal -->
<div class="modal fade" id="adminModal" tabindex="-1" aria-labelledby="adminModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content bg-dark text-white">
            <div class="modal-header">
                <h5 class="modal-title" id="adminModalLabel">ðŸ‘¤ Discord Admin Users</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p class="text-muted">Manage Discord users who can access the Admin Control Panel.</p>
                <div class="mb-3">
                    <label class="form-label">Add Admin User</label>
                    <div class="input-group">
                        <input type="text" class="form-control" id="newAdminId" placeholder="Discord User ID (e.g., 766595606574530581)">
                        <input type="text" class="form-control" id="newAdminNote" placeholder="Note (optional, e.g., Username)">
                        <button class="btn btn-success" type="button" onclick="addAdminUser()">Add</button>
                    </div>
                    <small class="form-text text-muted">To get a Discord User ID: Enable Developer Mode in Discord, right-click on user, and select "Copy User ID"</small>
                </div>
                <hr>
                <h6>Current Admin Users</h6>
                <div id="adminUsersList" class="list-group">
                    <!-- Admin users will be loaded here -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="saveAdminUsers()">Save Changes</button>
            </div>
        </div>
    </div>
</div> 